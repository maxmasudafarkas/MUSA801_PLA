"Rape",
"Other Assaults",
"Homicide - Criminal")
# wrangle crime data
crimeData <-
crime %>%
st_as_sf(coords = c('lng','lat'), crs = 4326) %>%
st_transform(st_crs(phlcrs)) %>%
mutate(year = year(dispatch_date)) %>%
rename('crimeType' = text_general_code) %>%
filter(crimeType %in% crimeTypes) %>%
st_filter(., phlcounty) %>%
dplyr::select(-dispatch_date, -crimeType)
# get nearest neighbor data
# set empty vector
crimeYears <-  c()
# loop through years adding crime data for each year
for (i in startYr:endYr) {
data <-
crimeData %>%
filter(year == i)
crimeYears <-
rbind(crimeYears,
fishnet %>%
mutate(crimeNN = nn_function(st_c(st_centroid(.)), st_c(data), 3),
year = i))
}
# SAVE locally
saveRDS(exposureNetYears, file = "../data/local/exposureNet.rds")
# loop through years adding crime data for each year
for (i in startYr:endYr) {
data <-
crimeData %>%
filter(year == i)
crimeYears <-
rbind(crimeYears,
fishnet %>%
mutate(crimeNN = nn_function(st_c(st_centroid(.)), st_c(data), 3),
year = i))
}
# loop through years adding crime data for each year
for (i in startYr:endYr) {
data <-
crimeData %>%
filter(year == i)
crimeYears <-
rbind(crimeYears,
fishnet %>%
mutate(crimeNN = nn_function(st_c(st_centroid(.)), st_c(data), 3),
year = i))
}
fishnetCentroids <- fishnet %>% st_c(st_centroid(.))
zData <- crimeData %>% filter(year == 2016)
nn_function(fishnetCentroids, zData, 3)
View(zData)
View(fishnetCentroids)
zData <- crimeData %>% filter(year == 2016) %>% st_c()
nn_function(fishnetCentroids, zData, 3)
fishnetCentroids <- fishnet %>% st_c(st_centroid(.)) %>% dplyr::select(X, Y)
fishnetCentroids <- fishnet %>% st_c(st_centroid(.)) %>% dplyr::select(X)
fishnetCentroids <-
fishnet %>%
st_c(st_centroid(.))
fishnetCentroids <-
fishnet %>%
st_centroid(.)
fishnetCentroids <-
fishnet %>%
st_centroid(.) %>%
dplyr::select(geometry)
fishnetCentroids <-
fishnet %>%
st_centroid(.) %>%
dplyr::select(geometry) %>%
st_c()
nn_function(fishnetCentroids, zData, 3)
crimeYears <- c()
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)),
data,
3))
# add to empty list
crimeYears <-
rbind(crimeYears, crimeNN)
}
# add both count and exposure to panel
crimeNetYears <-
merge(
crimeData %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(year, uniqueID) %>%
summarize(crime = n()) %>%
right_join(yearPanel) %>%
replace(is.na(.), 0),
st_drop_geometry(crimeYears))
# JOIN AND CALCULATE NEAREST NEIGHBOR DISTANCE
# Ordinance violations
exposureNet <-
rbind(schoolsData,
parksData,
transitData,
licensesData) %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID, legend) %>%
summarize(count = n()) %>%
full_join(fishnet) %>%
spread(legend, count, fill = 0) %>%
st_sf() %>%
dplyr::select(-`<NA>`) %>%
na.omit() %>%
ungroup() %>%
mutate(schoolsNN =
nn_function(st_c(st_centroid(.)), st_c(schoolsData), 3),
parksNN =
nn_function(st_c(st_centroid(.)), st_c(parksData), 3),
transitNN =
nn_function(st_c(st_centroid(.)), st_c(transitData), 3),
licensesNN =
nn_function(st_c(st_centroid(.)), st_c(licensesData), 3)) %>%
st_drop_geometry()
# JOIN ALL
# TURN previous table into YEARS and then join with CRIME table
exposureNetYears <-
merge(
exposureNet %>%
right_join(yearPanel),
crimeNetYears)
# SAVE locally
saveRDS(exposureNetYears, file = "../data/local/exposureNet.rds")
rm(fishnetCentroids)
rm(zData)
rm(z)
# join all features together
if (SWITCH == T) {
completeNet <-
permitsNetYears %>%
mutate(permitYear = year,
year = year - 3) %>%
left_join(salesNetYears) %>%
left_join(priceNetYears) %>%
left_join(sqftNetYears) %>%
left_join(debtNetYears) %>%
left_join(rentNetYears) %>%
left_join(individualOwnersNetYears) %>%
left_join(vacantNet) %>%
left_join(sheriffSalesNetYears) %>%
left_join(demoNetYears) %>%
left_join(jobsNetYears) %>%
left_join(exposureNetYears)
} else {
completeNet <- readRDS("../data/local/completeNetYears.Rds")
}
saveRDS(completeNet, "../data/local/completeNetYears.Rds")
# Moran's I? Neighborhood Effects?
# # add risk features to a final fishnet
# finalNet <-
#   left_join(occurrenceNet, st_drop_geometry(varsNet), by="uniqueID")
#
#
# # ADD NEIGHBORHOOD EFFECTS !!
#
# finalNet <-
#   st_centroid(finalNet) %>%
#     st_join(dplyr::select(neighborhoods, name), by = "uniqueID") %>%
#     st_join(dplyr::select(policeDistricts, District), by = "uniqueID") %>%
#       st_drop_geometry() %>%
#       left_join(dplyr::select(finalNet, geometry, uniqueID)) %>%
#       st_sf() %>%
#   na.omit()
View(completeNet)
View(crimeNetYears)
crimeEndpoint <- 'https://phl.carto.com/api/v2/sql?filename=incidents_part1_part2&format=csv&skipfields=cartodb_id,the_geom,the_geom_webmercator&q=SELECT%20text_general_code,dispatch_date%20,%20ST_Y(the_geom)%20AS%20lat,%20ST_X(the_geom)%20AS%20lng%20FROM%20incidents_part1_part2%20WHERE%20dispatch_date_time%20%3E=%20%27'
crimeStartDate <- paste0(startYr, '-01-01')
crimeEndDate <- paste0(endYr + 1, '-01-01')
paste0(crimeStartDate, '%27%20AND%20dispatch_date_time%20%3C%20%27' crimeEndDate)
paste0(crimeStartDate, '%27%20AND%20dispatch_date_time%20%3C%20%27', crimeEndDate)
paste0(crimeEndpoint, crimeStartDate, '%27%20AND%20dispatch_date_time%20%3C%20%27', crimeEndDate)
crime <- read_csv(paste0(crimeEndpoint, crimeStartDate, '%27%20AND%20dispatch_date_time%20%3C%20%27', crimeEndDate))
crime <- read_csv(paste0(crimeEndpoint, crimeQuery,'%27'))
crimeQuery <- paste0(crimeStartDate, '%27%20AND%20dispatch_date_time%20%3C%20%27', crimeEndDate)
crime <- read_csv(paste0(crimeEndpoint, crimeQuery,'%27'))
# set crime types to consider (keep only ASSAULTS)
crimeTypes <- c(
"Aggravated Assault Firearm",
"Aggravated Assault No Firearm",
"Rape",
"Other Assaults",
"Homicide - Criminal")
# wrangle crime data
crimeData <-
crime %>%
st_as_sf(coords = c('lng','lat'), crs = 4326) %>%
st_transform(st_crs(phlcrs)) %>%
mutate(year = year(dispatch_date)) %>%
rename('crimeType' = text_general_code) %>%
filter(crimeType %in% crimeTypes) %>%
st_filter(., phlcounty) %>%
dplyr::select(-dispatch_date, -crimeType)
# get nearest neighbor data
# set empty vector
crimeYears <- c()
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)),
data,
3))
# add to empty list
crimeYears <-
rbind(crimeYears, crimeNN)
}
# add both count and exposure to panel
crimeNetYears <-
merge(
crimeData %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(year, uniqueID) %>%
summarize(crime = n()) %>%
right_join(yearPanel) %>%
replace(is.na(.), 0),
st_drop_geometry(crimeYears))
# JOIN AND CALCULATE NEAREST NEIGHBOR DISTANCE
# Ordinance violations
exposureNet <-
rbind(schoolsData,
parksData,
transitData,
licensesData) %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(uniqueID, legend) %>%
summarize(count = n()) %>%
full_join(fishnet) %>%
spread(legend, count, fill = 0) %>%
st_sf() %>%
dplyr::select(-`<NA>`) %>%
na.omit() %>%
ungroup() %>%
mutate(schoolsNN =
nn_function(st_c(st_centroid(.)), st_c(schoolsData), 3),
parksNN =
nn_function(st_c(st_centroid(.)), st_c(parksData), 3),
transitNN =
nn_function(st_c(st_centroid(.)), st_c(transitData), 3),
licensesNN =
nn_function(st_c(st_centroid(.)), st_c(licensesData), 3)) %>%
st_drop_geometry()
# JOIN ALL
# TURN previous table into YEARS and then join with CRIME table
exposureNetYears <-
merge(
exposureNet %>%
right_join(yearPanel),
crimeNetYears)
# SAVE locally
saveRDS(exposureNetYears, file = "../data/local/exposureNet.rds")
# JOIN ALL
# TURN previous table into YEARS and then join with CRIME table
exposureNetYears <-
merge(
exposureNet %>%
right_join(yearPanel),
crimeNetYears)
View(crimeYears)
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year)
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year)
# add to empty list
crimeYears <-
rbind(crimeYears, crimeNN)
}
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year)
# add to empty list
crimeYears <-
yearPanel %>%
left_join(crimeNN)
}
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year)
# add to empty list
crimeYears <-
crimeYears %>%
left_join(crimeNN)
}
crimeYears <- yearPanel
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year)
# add to empty list
crimeYears <-
crimeYears %>%
left_join(crimeNN)
}
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year) %>%
st_drop_geometry()
# add to empty list
crimeYears <-
crimeYears %>%
left_join(crimeNN)
}
# get nearest neighbor data
# set empty vector
crimeYears <- yearPanel
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year) %>%
st_drop_geometry()
# add to empty list
crimeYears <-
crimeYears %>%
left_join(crimeNN)
}
# get nearest neighbor data
# set empty vector
crimeYears <- c()
crimeYears <- c()
# loop through years adding crime data for each year
for (year in startYr:endYr) {
# get crime data coordinates list for each year
data <-
crimeData %>%
filter(year == year) %>%
st_c()
# get distance to fishnet cells centroids
crimeNN <-
fishnet %>%
mutate(
crimeNN = nn_function(st_c(st_centroid(.)), data, 3),
year = year) %>%
st_drop_geometry()
# add to empty list
crimeYears <-
rbind(crimeYears, crimeNN)
}
View(crimeYears)
# add both count and exposure to panel
crimeNetYears <-
merge(
crimeData %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(year, uniqueID) %>%
summarize(crime = n()) %>%
right_join(yearPanel) %>%
replace(is.na(.), 0),
st_drop_geometry(crimeYears))
# add both count and exposure to panel
crimeNetYears <-
merge(
crimeData %>%
st_join(., fishnet, join = st_within) %>%
st_drop_geometry() %>%
group_by(year, uniqueID) %>%
summarize(crime = n()) %>%
right_join(yearPanel) %>%
replace(is.na(.), 0),
crimeYears)
View(crimeNetYears)
# JOIN ALL
# TURN previous table into YEARS and then join with CRIME table
exposureNetYears <-
merge(
exposureNet %>%
right_join(yearPanel),
crimeNetYears)
unique(licensesData %>% select(year))
licensesData %>%
dplyr::select(year)
g(licensesData)
# SAVE locally
saveRDS(exposureNetYears, file = "../data/local/exposureNet.rds")
saveRDS(jobsNetYears, file = "../data/local/jobsNet.rds")
# join all features together
if (SWITCH == T) {
completeNet <-
permitsNetYears %>%
mutate(permitYear = year,
year = year - 3) %>%
left_join(salesNetYears) %>%
left_join(priceNetYears) %>%
left_join(sqftNetYears) %>%
left_join(debtNetYears) %>%
left_join(rentNetYears) %>%
left_join(individualOwnersNetYears) %>%
left_join(vacantNet) %>%
left_join(sheriffSalesNetYears) %>%
left_join(demoNetYears) %>%
left_join(jobsNetYears) %>%
left_join(exposureNetYears)
} else {
completeNet <- readRDS("../data/local/completeNetYears.Rds")
}
saveRDS(completeNet, "../data/local/completeNetYears.Rds")
# Moran's I? Neighborhood Effects?
# # add risk features to a final fishnet
# finalNet <-
#   left_join(occurrenceNet, st_drop_geometry(varsNet), by="uniqueID")
#
#
# # ADD NEIGHBORHOOD EFFECTS !!
#
# finalNet <-
#   st_centroid(finalNet) %>%
#     st_join(dplyr::select(neighborhoods, name), by = "uniqueID") %>%
#     st_join(dplyr::select(policeDistricts, District), by = "uniqueID") %>%
#       st_drop_geometry() %>%
#       left_join(dplyr::select(finalNet, geometry, uniqueID)) %>%
#       st_sf() %>%
#   na.omit()
# WHAT is arrange doing?
# ungroup years
# take out geometry and uniqueID
featuresNet <-
completeNet %>%
arrange(uniqueID) %>%
ungroup() %>%
dplyr::select(-uniqueID) %>%
st_drop_geometry()
# SAVE locally
saveRDS(featuresNet, file = "../data/local/featuresNet.rds")
View(completeNet)
