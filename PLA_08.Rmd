---
title: "Philadelphia Legal Assistance: Adverse Possession"
author: "Adrian Leon, Max Masuda-Farkas, Gillian Xuezhu Zhao"
date: "28/01/2022"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---


# Philadelphia Legal Assistance

Smart Cities Practicum



```{r setup, include=FALSE}

# R Markdown options
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F, results = F, cache=T, cache.lazy = F)

# LOAD PACKAGES
library(basemaps)
library(caret)
library(geojsonR)
library(gganimate)
library(gifski)
library(gridExtra)
library(kableExtra)
library(knitr)
library(lubridate)
library(mapview)
library(riem)
library(scales)
library(sf)
library(spdep)
library(tidycensus)
library(tidyverse)
library(tigris)
library(viridis)

# R options setup
options(scipen = 999)
options(tigris_class = "sf")
options(tigris_use_cache = T)
options(knitr.graphics.error = F)

# additional functions from PPA book
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


# function shortcuts
g <- glimpse
m <- mapview
len <- length
st_c <- st_coordinates


# Aesthetic settings
colors <- c('#222222',
            '#eeeeee')

palette <- c("#676767",
             "#18b6c4",   # properties
             "#18c493",   # vacantLots
             "#f7c457",   # delinquencies
             "#f79c57",   # us bank liens
             "#f76957")   # sheriff sales

```


***

## Introduction


When life hands you a vacant lot, make a garden.


Such has been the philosophy of the enterprising residents of Philadelphia, a city that, like many in the United States, is home to thousands of properties that lie vacant in neighborhoods from Kensington to West Philadelphia. Rather than let them sit idle, Philadelphians have taken it upon themselves to tend to these lots as their own, converting them into cherished public assets. These properties come in all shapes and sizes, from small side yards to sprawling [community gardens](https://iglesiasgardens.com/) that span across multiple parcels.


Recently, however, a threat has emerged that could result in the sale of scores of these vacant properties.


The City of Philadelphia has been foreclosing on vacant properties in bulk to recover **delinquent taxes**. Following foreclosure, the City will initiate a forced sale through a public auction known as a **sheriff's sale**, transferring the property to the highest bidder. Neither the original owner nor the neighbors who have cared for the property in the owner's absence can stop such a sale once it's underway.


As if that were not enough, vacant lots in Philadelphia face an additional threat. In the late 1990's, the City of Philadelphia sold over 30,000 tax liens to **U.S. Bank**, a private financial institution, in an effort to raise funds for public education. (This effort proved largely [unsuccessful](https://controller.phila.gov/wp-content/uploads/2018/06/DelinquentRealEstateTaxes_November2013.pdf#page=20).) As a result, today over two thousand vacant lots in Philadelphia are encumbered by liens owned by U.S. Bank, entitling the bank unilaterally to foreclose on those properties, much like the City.


In light of these trends, neighbors and communities are rightly concerned that they may lose properties that, for years, have constructively been theirs. But there is reason for hope. 


A range of legal and policy options may be available to these stakeholders depending on their specific circumstances. Advocacy [efforts](https://www.pubintlaw.org/cases-and-projects/our-testimony-on-us-bank-liens-and-displacement-in-philadelphia/) are currently underway to halt sheriff's sales for certain classes of vacant lots. Some policy solutions already exist, especially for vacant lots that are [City-owned](https://phdcphila.org/land/buy-land/side-or-rear-yards/). In some cases, stakeholders may even have legal rights: Neighbors who have tended to vacant lots adjoining their properties may have a path to ownership through a legal doctrine known as [adverse possession](https://www.law.cornell.edu/wex/adverse_possession).


A variety of grassroots and legal advocacy organizations have taken up the mantle to explore these options, and more, to ensure that vacant lots remain in the care of the neighbors and communities who have invested in them for years. In collaboration with **Philadelphia Legal Assistance**, we are thus creating a web app to help residents, policymakers, and members of the public to understand the scope of this problem. The app will be designed to accomplish two, principal aims: (1) to visualize and explore the full portfolio of vacant properties in Philadelphia; and (2) to predict and rank which are under the greatest threat of development.


***


## Exploratory Analysis

To understand the scale of the challenges facing vacant properties in Philadelphia, we visualize some of the key datasets pertaining to those properties.


```{r data: base geometry}

### A. Geographic boundaries

# set CRS to Pennsylvania South NAD83 in meters
phlcrs <- 'EPSG:32129'


# get geometry for tracts in Philadelphia
phltracts <- 
  tigris::tracts(state = 42, county = 101) %>%
  dplyr::select(GEOID, geometry) %>%
  st_transform(st_crs(phlcrs))


# get geometry for the county of Philadelphia
phlcounty <-
  phltracts %>%
  st_union()


# set up the fishnet bins as the most granular unit of analysis
fishnet <- phlcounty %>%
  st_make_grid(.,
               cellsize = 250, 
               square = TRUE) %>%
  .[phlcounty] %>%                     # clip to Philadelphia County boundary
  st_sf() %>%
  mutate(uniqueID = rownames(.))


# Create a fishnet grid boundary of Philadelphia County
phlFishnet <- fishnet %>%
  st_union()


### B. Demographic

# Get API key loaded locally
censusKey <-  read_file('../censusapikey.R')

# load census api key from local file
census_api_key(censusKey)

# set consulted year
year <- 2019

# get variables names and codes
acsVariableList <- load_variables(year, "acs5", cache = TRUE)

# set census variables to consult
censusVars <-
  c("B02001_001E", # Total population 
    "B11001_002E", # Total households
    "B02001_002E", # Total white population 
    "B19013_001E", # Median household income
    "B25003_001E") # Tenure of household

# Get the data
demographics <-
  get_acs(geography = "tract",
          variables = censusVars,
          year = year,
          state = 42,
          county = 101,
          geometry= T,
          output = "wide") %>%
  st_transform(st_crs(phlcrs)) %>%
  rename(totalPop = "B02001_001E",
         totalHHs = "B11001_002E",
         whitePop = "B02001_002E",
         medHHInc = "B19013_001E",
         tenureHH = "B25003_001E") %>%
  dplyr::select(-NAME, -starts_with("B"))%>%
  replace(is.na(.), 0) %>%
  mutate(pctWhite = ifelse(totalPop > 0, whitePop / totalPop, 0),
         pctTenur = ifelse(totalPop > 0, tenureHH / totalPop, 0)) %>%
  mutate(nhMajMin = ifelse(pctWhite > 0.5, 1, 0),
         nhIncome = ifelse(medHHInc > mean(.$medHHInc), 1, 0),
         nhTenure = ifelse(pctTenur > 0.5, 1, 0)) %>%
  dplyr::select(nhMajMin, nhIncome, nhTenure) %>%
  st_transform(st_crs(phlcrs))
  

# Create a mask for the majority minority census tracts fishnet cells
majminFishnet <- 
  demographics %>%
  filter(nhMajMin == 1) %>%
  st_union() %>%
  st_intersection(fishnet) %>%
  fishnet[.,] %>%
  st_union()


### C. Properties

# [source]('https://www.opendataphilly.org/dataset/opa-property-assessments')

# Load properties from 1999 until now from the Office of Property Assessment.
# properties <- read_csv('https://opendata-downloads.s3.amazonaws.com/opa_properties_public.csv')

# OR local load
properties <- readRDS('../data/local/properties.rds')

# Selected variables of interest
propertiesVars <-
  c("category_code",                  # KEEP ------------------------------------determines if it is VACANT LAND
    #"exterior_condition",             # KEEP ------------------------------------how the exterior appears based on observation.
    #"frontage",                       # MODEL
    #"location",                       # KEEP for JOIN check****
    "market_value",                   # KEEP ------------------------------------the certified market value of the property.
    #"off_street_open",                # UNNECESSARY
    "owner_1",                        # KEEP
    "owner_2",                        # KEEP
    "parcel_number",                  # KEEP to JOIN***
    #"parcel_shape",                   # MODEL
    #"registry_number",                # KEEP to JOIN
    "sale_date",                      # KEEP
    #"sale_price",                     # KEEP
    #"taxable_land",                   # MODEL
    #"topography",                     # MODEL
    "total_area",                     # KEEP
    #"unfinished",                     # UNNECESSARY
    "year_built",                     # KEEP
    "zoning",                         # KEEP
    "pin",                            # KEEP to JOIN ****
    "lat",                            # KEEP****
    "lng")                            # KEEP****


# Data wrangling
propertiesData <- properties %>%
  dplyr::select(propertiesVars) %>%
  filter(!is.na(lat), !is.na(lng)) %>%              
  st_as_sf(coords = c("lat","lng"), crs = 4326) %>%
  st_transform(st_crs(phlcrs)) %>%
  st_join(demographics)


# save locally
# saveRDS(properties, file = "properties.rds")

```


---

### Properties and Vacant Lots


Today, out of the 580 thousand properties across Philadelphia, over 27,000 are vacant. No two of these properties are the same: Some are expansive, covering multiple parcels; others are small side yards adjacent to homes.  



```{r fig.width= 6, fig.height= 6}

# All properties map
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = propertiesData, color = palette[2], size = 0.5) +
  labs(title = 'All Properties',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank(),
        )

```




```{r data: vacant land}

# [source]('https://www.opendataphilly.org/dataset/vacant-property-indicators')

# OpenDataPhilly Vacant Property Indicator - Lots
vacantLand <- read_csv('https://opendata.arcgis.com/datasets/19c35fb02d544a9bad0032b58268c9f9_0.csv')

# Select useful variables --- NO GEOMETRY
vacantLandVars <-
  c(#"ADDRESS",                        # KEEP for JOIN CHECK
    "BLDG_DESC",                      # KEEP ------------------------------------Building description from OPA
    "OPA_ID",                         # KEEP to JOIN****
    #"ZONINGBASEDISTRICT",             # KEEP***
    "LAND_RANK")                      # KEEP?

# Data wrangling
vacantLandData <- vacantLand %>%
  dplyr::select(vacantLandVars) %>%
  mutate(vacant = 'vacant')


# JOIN to propertiesData
# propertiesData <---> vacantLandData
vacantLandProps <- propertiesData %>%
  inner_join(vacantLandData, by=c('parcel_number'='OPA_ID'))

# save locally
# saveRDS(vacantLand, file = "vacantLand.rds")
saveRDS(vacantLandProps, file = "vacantLandProps.rds")

```


A map of these vacant properties reveals also that they tend to cluster in space and are unevenly distributed across the city.  We hypothesize that these patterns are not arbitrary but are attributable to certain demographic and socio-economic divisions that pervade Philadelphia (a claim that will be validated later in this analysis).


```{r fig.width= 6, fig.height= 6}

# Vacant Lots in properties map

vacantLandData %>%
  mutate(vacant = 'vacant') %>%
  right_join(propertiesData, by = c('OPA_ID' = 'parcel_number')) %>%
  mutate(vacant = replace_na(vacant, 'not vacant')) %>%
  st_sf() %>%
  ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(aes(color = vacant), size=0.02) +
  labs(title = 'Vacant Land',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  scale_color_manual("", values= c(palette[1], palette[3]), labels= c("not vacant", "vacant")) +
  mapTheme() +
    mapTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = c(0.85, 0.15),
          legend.key = element_rect(color = NA, fill = NA),
          panel.border = element_blank(),
          panel.background = element_rect(fill = colors[2]),
          panel.grid.major = element_blank(),
          )

#mapSave_ggplot("vacantProperties")

```

---


### Tax Delinquent Vacant Lots

So long as the owner of a vacant property keeps up with her property taxes, there is no risk that the property will be foreclosed upon.  However, it is when a property falls into a state of tax delinquency —that is, when the owner fails to pay tax on the property— that such a property becomes vulnerable to a forced sale.  Much like a mortgage lender, the City is entitled to foreclose on properties that are tax delinquent and may put them up for a sheriff’s sale to collect on back taxes.


```{r supply tax delinquencies}

# [source]('https://www.opendataphilly.org/dataset/property-tax-delinquencies')

# Real Estate Delinquencies from OpenData Philly:
delinquencies <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+real_estate_tax_delinquencies&filename=real_estate_tax_delinquencies&format=csv&skipfields=cartodb_id,the_geom,the_geom_webmercator')

# Variables - Tax Delinquencies (53 vars)
delinquenciesVars <-
  c("opa_number",                     # KEEP to JOIN****
    #"street_address",                 # KEEP to JOIN check****
    #"owner",                          # UNNECESSARY
    #"co_owner",                       # UNNECESSARY
    "total_due",                      # KEEP ------------------------------------The total amount owner owes.
    "is_actionable",                  # KEEP?*** --------------------------------Action can be taken against the delinquent property.
    "num_years_owed",                 # KEEP ***for adverse possession reference
    "most_recent_year_owed",          # KEEP for reference
    "oldest_year_owed",               # KEEP for reference
    "most_recent_payment_date",       # KEEP for reference
    #"year_of_last_assessment",        # KEEP for reference
    "total_assessment",               # KEEP for reference
    #"building_code",                  # ???? ------------------------------------Building codes describe the building.
    #"general_building_description",   # ???? ------------------------------------General description of how the building is used.
    #"building_category",              # ???? ------------------------------------Type of Building Group (residential, commercial, etc.).
    "sheriff_sale",                   # KEEP*** ---------------------------------Property is in the Sheriff Sale Process (any stage).
    "liens_sold_1990s",               # KEEP*** ---------------------------------Property was included in 1997 Lien Sale.
    "liens_sold_2015")                # KEEP*** ---------------------------------Property is included in Recent Lien Sales.


# Data wrangling
delinquenciesData <- delinquencies %>%
  dplyr::select(delinquenciesVars) %>%
  mutate(opa_number = sprintf("%09d", opa_number))


# JOIN to properties
# propertiesData <---> delinquenciesData
delinquenciesProps <- propertiesData %>%
  inner_join(delinquenciesData, by = c('parcel_number'='opa_number')) %>%
  st_sf()

# save locally
# saveRDS(delinquencies, file = "delinquencies.rds")


# map vacant properties (points)
delinquenciesVacantProps <-
  left_join(vacantLandProps,
            delinquenciesProps %>% st_drop_geometry() %>% mutate(delinquentStatus = 1),
            by = "parcel_number") %>%
  mutate(delinquentStatus = ifelse(is.na(delinquentStatus) == F, 1, 0),
         delinquentType = ifelse(liens_sold_1990s == T, 2, delinquentStatus), # delinquent type: 0 not, 1 yes, 2 us bank
         delinquentType = replace_na(delinquentType, 0))


```



As seen in the map below, not all vacant properties in Philadelphia are tax delinquent, but a substantial share —29percent—a re.  Within certain legal parameters, the City may exercise its rights to foreclose on these properties, many of which serve the very community uses organizations such as Philadelphia Legal Assistance has set out to protect.


```{r fig.width= 6, fig.height= 6}

# Map delinquent properties in relation to Vacant properties
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = delinquenciesVacantProps, 
          aes(color = factor(delinquentStatus)), 
          size = 0.02) +
  scale_color_manual("Is the land delinquent?", values= c(palette[1], palette[4]), labels= c("no", "yes")) +
  labs(title = 'Delinquent Vacant Land',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.key.size = unit(1,"line"),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        ) 

```


Just as the distribution of vacant properties exhibits certain discernible spatial patterns, so too with tax delinquent vacant properties.  The **29 percent** of vacant properties which are tax delinquent cluster in the North Philadelphia region of the city, indicating that those properties which are most exposed to tax foreclosure risk are near to one another.



>Where are these delinquencies concentrated?

```{r fig.width= 6, fig.height= 6}

# map vacant properties (fishnet)
delinquenciesVacantNet <- delinquenciesVacantProps %>%
  mutate(vacant = 1) %>%
  select(delinquentStatus, vacant) %>%
  aggregate(fishnet, sum) %>% 
  mutate(countDelinquent = replace_na(delinquentStatus, 0),
         vacant = replace_na(vacant, 0)) %>%
  select(-delinquentStatus)


# delinquencies heat map
ggplot() +
  geom_sf(data = phlFishnet, color = NA, fill = colors[1]) + 
  geom_sf(data = subset(delinquenciesVacantNet, vacant > 0), aes(fill = countDelinquent), color = NA, inherit.aes = FALSE) + 
  scale_fill_viridis(
    option = "mako",
    trans = "log1p",
    direction = 1) +
  guides(
    size = F,
    fill= guide_colorbar(barheight = 7, title.position = "top")) +
  labs(title = 'Delinquent Vacant Land Distribution',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.2),
        legend.title = element_text(size = 8, color = colors[1], hjust = 0.5),
        legend.background = element_blank(),
        legend.text = element_text(size = 8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid = element_blank(),
        )

#mapSave_ggplot("delinquentVacantProperties_fishnet")

```



> What is the trend in delinquencies?


```{r fig.width= 6, fig.height= 4}

# trend of delinquencies # whether it is vacant or not, doesn't matter
delinquenciesProps %>%
  group_by(oldest_year_owed) %>%
  summarise(countProp = n()) %>%
  st_drop_geometry() %>% 
  ggplot(
    aes(x=oldest_year_owed, y=countProp)) + 
  geom_area(fill = palette[4], alpha = 0.8) + 
  labs(title = 'Delinquencies by Last Year Owed',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  xlab("year") +
  ylab("tax delinquent properties") +
  theme(panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()
        )

#chartSave_ggplot("delinquentTrend")

```



```{r fig.width= 6, fig.height= 4}

# trend of delinquencies of vacant properties
delinquenciesVacantProps %>%
  group_by(oldest_year_owed) %>%
  summarise(countProp = n()) %>%
  st_drop_geometry() %>%
  ggplot(
    aes(x = oldest_year_owed, y = countProp)) + 
  geom_area(fill = palette[4], color = NA, alpha = 0.8) + 
  labs(title = 'Delinquencies by Oldest Year Owed',
       subtitle = 'Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  xlab("year") +
  ylab("tax delinquent vacant properties") +
  ylim(c(0, 1600)) +
  theme(panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()
        )

#chartSave_ggplot("delinquentVacantTrend")
```


---


### US Bank Liens


A further subclass of vacant properties in Philadelphia are those to which taxes are owed to U.S. Bank, a private financial institution that purchased a large portfolio of tax liens from the City of Philadelphia in the late 1990’s. Among all vacant properties in Philadelphia, over 5 percent fall into this category and are subject to liens owned by U.S. Bank. Furthermore, of all vacant properties that are tax delinquent, nearly 20 percent are encumbered by debt to U.S. Bank, entitling it to initiate foreclosure proceedings just like the City. As will be seen later, a large share of recent sheriff’s sales has implicated properties encumbered by liens owned by U.S. Bank.


```{r fig.width= 6, fig.height= 6}

# US Bank Liens comparison map
delinquenciesVacantProps %>%
  filter(delinquentType > 0) %>%
  ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1]) + 
  geom_sf(aes(color = factor(delinquentType)), 
          size = 0.02) +
  scale_color_manual("", values = c(palette[1], palette[5]),
                     labels= c("delinquent vacant", "US Bank lien")) +
  labs(title = 'US Bank Delinquent',
       subtitle = 'Vacant Land Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        )

#mapSave_ggplot("usbankVacantProperties")

```


```{r fig.width= 4, fig.height= 6}

delinquenciesVacantProps %>%
  filter(delinquentStatus == 1) %>%
  group_by(liens_sold_1990s) %>%
  summarise(countUsBank = n()) %>%
  st_drop_geometry() %>%
  ggplot(aes(liens_sold_1990s, countUsBank, fill = factor(liens_sold_1990s))) + 
  geom_bar(position = "dodge", stat = "summary", fun = "mean", width = 0.8) +
  labs(title = 'US Bank Delinquent',
       subtitle = 'Vacant Land Properties in Philadelphia County') +
  scale_fill_manual(values = c(palette[1], palette[5]),
                    name="") +
  scale_x_discrete(name = "US bank lien", 
                   labels = c("no", "yes")) +
  ylab("properties") +
  theme(legend.position = "none",
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major.x =  element_blank()
        )

#chartSave_ggplot("usbankBar")

```



---


### Sheriff Sales

Once either the City or U.S. Bank petitions to foreclose on a tax delinquent property in court, unless the property owner appears to contest the foreclosure or the court independently finds a reason not to foreclose, the court will grant the petition and allow the property to be sold via a sheriff’s sale. As alluded to in the Introduction, communities and neighbors who may have cared for the property for years in the owner’s absence frequently are not even made aware that a property has been listed, let alone sold, at a sheriff’s sale.


```{r data: transfers}

# [source]('https://www.opendataphilly.org/dataset/real-estate-transfers')

# OpenDataPhilly Endpoint of Property Assessment History:
# transfers <- read_csv('https://opendata-downloads.s3.amazonaws.com/rtt_summary.csv')
# transfers <- read_csv('https://opendata.arcgis.com/datasets/88e5bc291b834606bd49f6fd6dca226e_0.csv')

# OR load locally
transfers <- readRDS('../data/local/transfers.rds')

# OpenDataPhilly - Transfers (48 variables)
transfersVars <- 
  c("document_type",                # KEEP*** -----------------------------------refers to type of Real Estate Transaction
    "display_date",                 # KEEP***
    "street_address",               # KEEP for JOIN check
    "grantors",                     # KEEP --------------------------------------seller (on deeds), or borrower (on mortgages)
    "grantees",                     # KEEP --------------------------------------buyer, recipient, new owner, or lien holder
    #"total_consideration",          # KEEP?** -----------------------------------good exchanged for the real estate (usually money)
    #"assessed_value",               # KEEP?** -----------------------------------assess value by OPA
    #"common_level_ratio",           # UNNECESSARY -------------------------------fair market : assessment values ratio
    "fair_market_value",            # KEEP?** -----------------------------------assessment value by common level ratio
    #"receipt_date",                 # UNNECESSARY - display_date is used
    #"recording_date",               # UNNECESSARY - display_date is used
    #"document_date",                # UNNECESSARY - display_date is used
    "opa_account_num",              # KEEP****to join
    "property_count")               # KEEP --------------------------------------Number of properties in document


# Data wrangling
transfersData <- transfers %>%
  dplyr::select(all_of(transfersVars)) %>%
  filter(!is.na(opa_account_num)) %>%
  filter(document_type %in% c('DEED',
                              'DEED LAND BANK',
                              'DEED MISCELLANEOUS',
                              'DEED MISCELLANEOUS TAXABLE',
                              'DEED OF CONDEMNATION',
                              'DEED SHERIFF'))

# JOIN to properties
# propertiesData <---> transfersData

# if a parcel_number has multiple deeds, I manipulated data to shift deed sheriff first
# so distinct() will grab deed sheriff and neglect others
transfersProps <- propertiesData %>%
  inner_join(transfersData, by= c('parcel_number'='opa_account_num'))%>% 
  mutate(document_type = factor(document_type,
                                labels(c("DEED SHERIFF" = 1,
                                         "DEED" = 2,
                                         "DEED MISCELLANEOUS" = 3,
                                         "DEED OF CONDEMNATION" = 4,
                                         "DEED LAND BANK" = 5,
                                         "DEED MISCELLANEOUS TAXABLE" = 6))))

  
# save locally
# saveRDS(transfers, file = "transfers.rds")

```


Where sheriff’s sales are taking place in Philadelphia can be shown on the map. Unsurprisingly, these properties cluster in thesame regions in North Philadelphia where there is the highest concentration of tax delinquent vacant properties. Nearly 30 percent of all tax delinquent properties either have already been sold at a sheriff’s sale or are scheduled for sheriff’s sales.



```{r data: sheriff sales, fig.width= 6, fig.height= 6}

# sheriff sales after 2021 from client
sheriffSales_21 <- read_csv('./data/sheriffSales_21.csv') %>%
  distinct(OPA, .keep_all=TRUE)                                                # remove duplicates

# Sheriff Sales before 2021 from real estate transfers data (completed)
sheriffSales_20 <-
  transfersProps %>%
  filter(document_type == "DEED SHERIFF") %>%
  arrange(parcel_number, document_type) %>%
  distinct(parcel_number, .keep_all = TRUE)


# join all sheriff sales info we have together
## sheriff sales data from transfers
sheriffProps <-
  left_join(
    delinquenciesVacantProps,
    st_drop_geometry(sheriffSales_20),
    by = "parcel_number") %>%
  distinct(parcel_number, .keep_all = T) %>%
  merge(., sheriffSales_21,
        by.x = "parcel_number", by.y = "OPA", all.x = T, no.dups = T) %>%
  mutate(pastSheriffSale = ifelse(document_type == "DEED SHERIFF", 1, 0)) %>%   #  past records only
  mutate(pastSheriffSale = replace_na(pastSheriffSale, 0)) %>%
  mutate(futureSheriffSale = ifelse(document_type == "DEED SHERIFF" | is.na(Status) == F | sheriff_sale == "Y", 1, 0)) %>% # future
  mutate(futureSheriffSale = replace_na(futureSheriffSale, 0)) %>%
  mutate(allSheriffSales = ifelse(pastSheriffSale == 1 | futureSheriffSale == 1, 1, 0),
         sheriffSaleYear = year(as.Date(display_date))) 


# Map sheriff sales in relation to vacant delinquent properties
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1]) + 
  geom_sf(data = subset(sheriffProps, delinquentStatus == 1), 
          aes(color = factor(allSheriffSales)), 
          size = 0.2) +
  scale_color_manual("", values= c(palette[1], palette[6]),
                     labels= c("vacant delinquent", "sheriffs sale")) +
  labs(title = 'Historical Sheriff Sales',
       subtitle = 'Vacant Land Properties in Philadelphia County',
       caption = 'OpenDataPhilly') +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        )

```


The urgency of the present problem can be further understood when sheriff’s sales are displayed as a function of time. In the past decade, the number of yearly sheriff’s sales has increased dramatically, as shown in the chart below. One plausible theory explaining this recent uptick is that the value of vacant property appreciates with the overall real estate market. The chart loosely proves this correlation: Sheriff’s sales fell to an all-time low in the immediate aftermath of the **2008 subprime mortgage crisis**, increased almost exponentially in the past 5-10 years, and briefly dropped off again in the wake of the coronavirus pandemic. We believe that this recent downtick will likely be temporary, however, as the City moved sheriff’s sales online, opening properties to a wider number of potential buyers.



```{r fig.width= 6, fig.height= 4}

# TO TABLE
# trend of sheriff's sale 
# calculate how many sheriff sale for delinquent vacant properties 
sheriffProps %>%
  group_by(allSheriffSales) %>%
  summarise(countSheriffSale = n()) %>%
  st_drop_geometry()


# plot a chart of sheriff sales
sheriffProps %>%
  filter(delinquentStatus == 1) %>%
  group_by(pastSheriffSale, sheriffSaleYear) %>%
  summarise(countSheriffSale = n()) %>%
  st_drop_geometry() %>%
  filter(pastSheriffSale == 1) %>%
  ggplot(aes(x = as.numeric(sheriffSaleYear), y= countSheriffSale)) + 
  geom_area(fill = palette[6], alpha = 0.8) + 
  geom_vline(xintercept = 2017, color = palette[3], size = 1) +
  xlab("year") +
  scale_x_continuous(
    breaks = seq(from = 1999, to = 2021, by = 2),
    limits = c(1999, 2021)) +
  ylab("sheriff's sales") +
  labs(title = 'Sheriff Sales: Historical and Scheduled',
       subtitle = 'Vacant Land Properties in Philadelphia County',
       caption = 'OpenDataPhilly & Adam Butler') +
  geom_text(x = 2017, y = 300, label = "", angle = 0) +
  theme(legend.position = "none",
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank()
        )

#chartSave_ggplot("sheriffSaleTrend")


```



## Demand-side data

### L&I Building and Zoning Permits


```{r data: permits}

# [source]('https://www.opendataphilly.org/dataset/licenses-and-inspections-building-permits')

# Load PERMITS data from OpenDataPhilly's Carto API
# permits <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*,+ST_Y(the_geom)+AS+lat,+ST_X(the_geom)+AS+lng+FROM+permits&filename=permits&format=csv&skipfields=cartodb_id')

# OR local load
permits <- readRDS('../data/local/permits.rds')


# List the permit data set variables needed
permitsVars <-
  c('parcel_id_num',                 # KEEP for JOIN
    'permittype',                    # KEEP*****
    'permitdescription',             # KEEP for reference
    #'commercialorresidential',        # MAYBE
    'typeofwork',                    # KEEP****
    #'approvedscopeofwork',           # UNNECESSARY - detailed description
    'permitissuedate',               # KEEP***
    'status',                        # KEEP
    'applicanttype',                 # MAYBE
    #'contractor[...]',               # UNNECESSARY
    'opa_account_num',               # KEEP for JOIN****
    #'address',                       # KEEP for JOIN check
    #'unit_type',                     # UNNECESSARY
    'lng','lat'
    #'geometry'
    )

# EXAMINE VARIABLES
# permittype
permitTypes <- as.data.frame(table(permits$permittype))

# select permittyoe
permitCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING',                 #   11187   # "2015-12-02" to NOW ("2022-01-29")
    'ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING'               #    7617   # "2007-01-02" to "2020-03-12"
    )

# Old categories
permitCatsA <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING')              #    7617   # "2007-01-02" to "2020-03-12"

# New categories
permitCatsB <- 
  c('BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Building categories
permitBuildingCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING')   #   15909   # "2015-01-06" to NOW ("2022-01-29")

# Zoning categories
permitZoningCats <- 
  c('ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING',              #    7617   # "2007-01-02" to "2020-03-12"
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Data wrangling ONE
# Filter data with PERMIT TYPES (building or zoning)
permitsData <- permits %>%
  dplyr::select(permitsVars) %>%
  filter(permittype %in% permitZoningCats) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = phlcrs) 

# type of work across SELECTED categories (48):
permitTypesOfWork <- as.data.frame(table(permitsData$typeofwork)) 

# All categories
permitTypeOfWorkCats <- 
  c(#'ADD',                                              #   1665 ***OLD ***ZONING {New construction attached or added to existing}
    #'ADDITION AND/OR ALTERATION',                       #  17051 ***NEW ***BUILDING (6290)  ***RESIDENTIAL BUILDING (10761)
    #'CHANGE OF USE',                                    #   3046 ***NEW ***ZONING {General change of use}
    'COMBINED LOT LINE RELOCATION AND NEW DEVELOPMENT', #    313 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'COMDEM',                                           #   1163 ***OLD ***ZONING {Complete demolition}
    'ENTIRE',                                           #   2910 ***OLD ***ZONING (-2890) ***BUILDING {Entire structure}
    'ENTSTR',                                           #   3638 ***OLD ***ZONING
    'FULL DEMOLITION',                                  #    644 ***NEW ***ZONING {Full demolition}
    'LOT LINE RELOCATION',                              #    317 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'LOTLIN',                                           #   2527 ***OLD ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'NEW CONSTRUCTION',                                 #<- 6292 ***NEW ***BUILDING (1812) ***RESIDENTIAL BUILDING (4480)
    'NEW CONSTRUCTION (SHELL ONLY)',                    #<-   19 ***NEW ***BUILDING
    #'NEW CONSTRUCTION (STAND ALONE)',                   #<-   48 ***NEW ***RESIDENTIAL BUILDING
    'NEW CONSTRUCTION, ADDITION, GFA CHANGE',           #<- 4986 ***NEW ***ZONING {New construction attached or added to existing}
    'NEWCON'#                                           #<- 5539 ***OLD ***ZONING (-3) ***BUILDING {New construction of structure}
    #'PARTCH',                                           #   3317 ***OLD ***ZONING {Change in use}
    #'SFADD',                                            #   3149 ***OLD ***ZONING {Add square footage to existing}
    )
    
# Filter data with PERMIT TYPES (building or zoning)
permitsZoningData <- permitsData %>%
  filter(typeofwork %in% permitTypeOfWorkCats)


# JOIN to properties
# permitsZoningData <---> propertiesData
permitsProps <- propertiesData %>%
  inner_join(st_drop_geometry(permitsZoningData),  by = c('parcel_number'='opa_account_num'))

# permits by quarter by fishnet cell
permitsNet <- permitsProps %>%
  st_join(fishnet, left=F) %>%
  mutate(year = year(permitissuedate),
         month = month(permitissuedate),
         quarter = case_when(
           month %in% c(1, 2, 3) ~ 1,
           month %in% c(4, 5, 6) ~ 2,
           month %in% c(7, 8, 9) ~ 3,
           month %in% c(10, 11, 12) ~ 4)) %>%
  mutate(period = paste(year, quarter, sep='-')) %>%
  group_by(period, uniqueID) %>%
  summarize(permitCount = sum(n())) %>%
  st_drop_geometry()

# random cross validation ID (out of 100) for later use
# mutate(uniqueID = rownames(.)) %>%
# mutate(cvID = sample(round(nrow(fishnet)/24), size=nrow(fishnet), replace=T)) 

# create empty panel with all possible time/space combinations by fishnet grids
basePanel <- 
  expand.grid(period = unique(permitsNet$period), 
              uniqueID = unique(fishnet$uniqueID))

# join panel to fishnet geometry
permitsPanel <- 
  permitsNet %>%
  right_join(basePanel) %>% 
  replace(is.na(.), 0) %>%
  left_join(fishnet) %>%
  st_sf()

# save locally
# saveRDS(permits, file = "permits.rds")

```


---


## Demographic Patterns


Because vacant properties are frequently a signal of disinvestment, where they tend to cluster can reveal much about the socio-economic profile of a city. In Philadelphia, the distribution of vacant properties is markedly uneven, which is a proxy for the spatial inequality of the greater city.

---

### Racial disparity

Race is one context in which this unevenness is apparent. Both vacant land and tax delinquent properties are overrepresented in majority–minority neighborhoods relative to majority white neighborhoods. If properties become vacant and tax delinquent in places where economic investment is low, this indicates that investment tends to happen along racial lines.


```{r fig.width=12, fig.height=6}

# set color palette
color1 <- "#ff6e14" 
color2 <- "#00bbc2"

majMin <- c('nhMajMin','non-white','white')
income <- c('nhIncome', 'below', 'over')
tenure <- c('nhTenure', 'not-owner', 'owner')


# define function to sum
getNeighFactor <-
  function(dataframe, name, vars) {
    dataframe %>%
      group_by(dataframe[[vars[1]]]) %>%
      summarize(nhCount = sum(n())) %>%
      na.omit() %>%
      mutate(var = c(vars[2],vars[3]),
             dataset = name) %>%
      dplyr::select(-1) %>%
      st_drop_geometry() 
  }


# define function to plot in one single chart
plotNeighFactors <- 
  function(factors, title) {
    allFactors <- rbind(
    getNeighFactor(propertiesData, 'properties', factors),
    getNeighFactor(vacantLandProps, 'vacantLand', factors),
    getNeighFactor(delinquenciesProps, 'delinquencies', factors),
    getNeighFactor(permitsProps, 'permits', factors)) %>%
    mutate(factor = factor(dataset, levels = c("properties", "vacantLand", "delinquencies", "permits")))
    
    # get bar chart
    object1 <- allFactors %>%
    #filter(dataset != 'properties') %>%
    ggplot(aes(var, nhCount, fill = var)) + 
    geom_bar(stat = "identity", width = .8) +
    scale_fill_manual(values = c(color1, color2)) +
    labs(title="Neighborhood effects",
         subtitle = title,
         x = "",
         y = "properties") +
    geom_text(aes(label = var, color = var), vjust = -.5) +
    scale_colour_manual(values = c(color1, color2)) +
    facet_wrap(~factor, ncol = 4, strip.position = "bottom") +
    plotTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = "none",
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#ffffff"),
          panel.grid.major.x = element_blank(),
          strip.background = element_rect(fill = "#ffffff"),
          strip.text.x = element_text(size = 16, color = colors[1], hjust=0.05)
          )
    
    # produce map
    object2 <-
      demographics %>%
      dplyr::select(factors[1]) %>%
      mutate(var = case_when(
        .[[factors[1]]] == 0 ~ factors[2],
        .[[factors[1]]] == 1 ~ factors[3])) %>%
      dplyr::select(-factors[1]) %>%
      ggplot() +
      geom_sf(aes(fill = var), color = NA) +
      scale_fill_manual(values = c(color1, color2)) +
      mapTheme() +
      theme(axis.text.x = element_blank(),
            legend.position = "none",
            panel.border = element_blank(),
            panel.background = element_rect(fill = "#ffffff"),
            panel.grid.major.x = element_blank())
    
    # put together and ggplot
    grid.arrange(object1,
                 object2,
                 ncol = 2,
                 widths = c(2, 1))
    }


plotNeighFactors(majMin, "Number of properties by Majority racial composition")

```


### Income disparity


Median income is another demographic feature affecting the distribution of vacant properties in Philadelphia. Vacant properties and tax delinquent properties are represented in greater numbers in areas with households below the median income than in those above. The reason for this distribution may be self-evident: Higher income households would be naturally more equipped to keep up and pay taxes on property than low-income households.


```{r fig.width=12, fig.height=6}

color1 <- "#fc754c"
color2 <- "#4c84f5" 

plotNeighFactors(income, "Number of properties by Relation of Census Tract Median to County Average Household Income")

```

---

### Home ownership disparity

Finally, whether a neighborhood is primarily composed of renters or owners appears to be correlated to the neighborhood’s relative share of vacant properties. Specifically, those with a higher proportion of non-owners see higher number of vacant properties and tax delinquent properties than those predominately comprised of owners.



```{r fig.width=12, fig.height=6}

color1 <- "#fc5a4c"
color2 <- "#4cbaf5"

plotNeighFactors(tenure, "Number of properties by Amount of Property Ownership")

```


---


## Development Activity


As the real estate market has continued to heat up in Philadelphia over the past decade, development activity has increased at a steady clip. Vacant and tax delinquent properties have lately become attractive to developers as a result, so to understand which vacant properties may be at greatest risk of disposition, one must also understand which areas are seeing the steepest rise in development activity.


A readily available proxy for development activity is zoning permits. For all forms of new real estate development, developers must obtain a zoning permit from the City of Philadelphia, even where the development is allowed by right. As such, a map of zoning permits in Philadelphia, shown below, can illustrate where development activity is clustering.



```{r fig.width= 8, fig.height= 8, results='markup'}

# Create Animation
animation <- 
  ggplot() +
  geom_sf(data = permitsPanel, aes(fill = permitCount), color = NA) +
  scale_fill_viridis(option = "magma",
                     limits = c(0, 20),
                     trans = "log1p",
                     breaks = c(0, 5, 10, 20),
                     direction = 1) +
  labs(title = "Zoning permits issued in Philadelphia",
       fill = "",
       caption = "Source: OpenDataPhilly") +
  guides(fill= guide_colorbar(barheight = 9, title.position = "bottom", label.position = "right")) +
  geom_text(data = permitsPanel,
            aes(label = substr(period, 1, 4)),
            size = 8, x = -Inf, y = Inf, vjust = 1.5, hjust = -.1, colour = "black") +
    transition_manual(period) +
    mapTheme() +
    theme(legend.position = c(0.85, 0.2),
          legend.background = element_blank(),
          panel.border = element_blank(),
          panel.background = element_rect(fill = colors[2]),
          panel.grid = element_blank()
          )

animate(animation, duration=20, renderer = gifski_renderer())

```


Where development is occurring spatially is only one relevant component, however. Equally important is the time element. The below chart displays how the real estate market has moved and increased over time.



```{r fig.width= 12, fig.height= 8}

# classify zoning permits by five-year periods
permitsLustrums <- 
  permitsPanel %>%
  mutate(year = as.integer(substr(period, 1,4)),
         lustrum = case_when(
           year %in% seq(2007, 2011) ~ '2007-2011',
           year %in% seq(2012, 2016) ~ '2012-2016',
           year %in% seq(2017, 2021) ~ '2017-2021'
         )) %>%
  filter(year != '2022') %>%
  dplyr::select(-period, -year) %>%
  group_by(lustrum, uniqueID) %>%
  summarize(permitCount = sum(permitCount))


# side-by-side five-year period zoning permits
permitsLustrums %>%
  ggplot() +
  geom_sf(aes(fill = permitCount), color = NA) +
  scale_fill_viridis(
    option = "magma",
    limits = c(0,120),
    trans = "log1p",
    breaks = c(0,30,60,120),
    direction = 1) +
  labs(
    title = "Zoning permits issued in Philadelphia",
    subtitle = "by five-year periods. All neighborhoods.",
    fill = "number of permits",
    caption = "Source: OpenDataPhilly") +
  guides(
    size = F,
    fill= guide_colorbar(barwidth = 21, title.position = "top")) +
  facet_wrap(~lustrum, ncol = 3) +
  mapTheme() +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    panel.border = element_blank(),
    panel.background = element_rect(fill = colors[2]),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = colors[2]),
    strip.text.x = element_text(size = 12, color = colors[1], hjust=0.01)
    )

```


Much like with vacant properties, development activity tracks with specific demographic patterns, as well. The map below shows majority–minority Philadelphia neighborhoods with majority white neighborhoods removed, in order to underscore the steady movement of development activity into majority–minority neighborhoods and out of majority white ones, a process most commonly known as gentrification.


```{r fig.width= 12, fig.height= 8}

# side-by-side five-year period zoning permits
permitsLustrums %>%
  ggplot() +
  geom_sf(aes(fill = permitCount), color = NA) +
  scale_fill_viridis(
    option = "magma",
    limits = c(0,120),
    trans = "log1p",
    breaks = c(0,30,60,120),
    direction = 1) +
  labs(
    title = "Zoning permits issued in Philadelphia",
    subtitle = "by five-year periods. Non-white majority neighborhoods.",
    fill = "number of permits",
    caption = "Source: OpenDataPhilly") +
  guides(
    size = F,
    fill= guide_colorbar(barwidth = 21, title.position = "top")) +
  geom_sf(data = majminFishnet, fill = colors[2], color = colors[2], alpha= 1) +
  geom_sf(data = phlFishnet, fill = NA, colour = colors[1]) +
  facet_wrap(~lustrum, ncol = 3) +
  mapTheme() +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    panel.border = element_blank(),
    panel.background = element_rect(fill = colors[2]),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = colors[2]),
    strip.text.x = element_text(size = 12, color = colors[1], hjust=0.01)
    )

```


Finally, the chart below shows how the zoning permit issue activity for vacant land tax delinquent properties in Philadelphia strongly follows the same activity of the overall properties throughout the city. 


```{r fig.width= 8, fig.height=4}

allPermitsProps <-
  left_join(delinquenciesVacantProps,
            st_drop_geometry(permitsProps),
            by=c("parcel_number")) %>%
  distinct(parcel_number, .keep_all = TRUE)

tabPermitByYr <-
  allPermitsProps %>%
  filter(is.na(permittype) == F) %>%
  group_by(is.na(permittype), year(permitissuedate)) %>%
  summarise(countPermit = n()) %>%
  st_drop_geometry() 

tabPermitAllByYr <- 
  permitsProps %>%
  group_by(is.na(permittype), year(permitissuedate)) %>%
  summarise(countPermit = n()) %>%
  st_drop_geometry() 

tabPermitBothByYr <-
  merge(tabPermitByYr, tabPermitAllByYr, by="year(permitissuedate)") %>%
  dplyr::select(1,3,5) %>%
  rename("year" = 1,
         "permitOnVacant" = 2,
         "permitPhilly" = 3) %>%
  gather(key="variable", value="value", -year)


# chart

tabPermitBothByYr %>%
  ggplot(aes(x = year, y = value, color = variable)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(from = 2005,
                                to = 2025,
                                by = 2)) +
  ylab("zoning permits") +
  scale_color_manual(values = c(palette[3], palette[6]),
                     labels = c("Vacant Sites", "Philadelphia"),
                     name="legend")  +
  labs(title = 'Development indictator',
       subtitle = 'Zoning permits issued in Philadelphia by vacancy of properties',
       caption = 'OpenDataPhilly') +
  geom_text(x = 2017, y = 300, label = "", angle = 0) +
  theme(legend.position = "right",
        legend.title = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major.x =  element_blank(),
        panel.grid.minor.x =  element_blank()
        )

```





```{r}


# if a parcel_number has multiple sales, we only get the latest one
salesProps <- transfersProps %>%
  drop_na(total_area) %>% 
  mutate(document_type = as.character(document_type)) %>%  # to ignore Gillian deed factor levels
  group_by(parcel_number) %>%
  slice(which.max(sale_date)) %>% # to get only the latest one
  mutate(year = year(sale_date),
         month = month(sale_date),
         quarter = case_when(
           month %in% c(1, 2, 3) ~ 1,
           month %in% c(4, 5, 6) ~ 2,
           month %in% c(7, 8, 9) ~ 3,
           month %in% c(10, 11, 12) ~ 4)) %>%
  mutate(period = paste(year, quarter, sep='-')) %>%
  mutate(sqftPrice = fair_market_value/total_area) %>%
  st_sf()


# All sales BEFORE 2019-01-01 and turn difference into days
salesProps19 <-
  salesProps %>%
  filter(year < 2019) %>%
  mutate(daysFromLastSale = difftime(as.Date.character('2019-01-01'), sale_date, units = 'days'))

salesNet <- salesProps19 %>%
  dplyr::select(daysFromLastSale) %>%
  st_join(fishnet, left = F) %>%
  group_by(uniqueID) %>%
  summarize(permitCount = sum(n())) %>%
  st_drop_geometry()


# create empty panel with all possible time/space combinations by fishnet grids
basePanel <- 
  expand.grid(period = unique(salesNet$period), 
              uniqueID = unique(fishnet$uniqueID))

# join panel to fishnet geometry
salesPanel <- 
  salesNet %>%
  right_join(basePanel) %>% 
  replace(is.na(.), 0) %>%
  left_join(fishnet) %>%
  st_sf()

g(fishnet)



# sales from 2016 to 2021
salesLastFive <-
  salesProps %>%
  filter(year > 2016 && year <= 2021)


# sales from 2018 to TRAIN
sales2018 <-
  salesProps %>%
  filter(year == 2018)


# sales from 2019 to TEST
sales2019 <-
  salesProps %>%
  filter(year == 2019)







```


```{r}

animation <- 
  ggplot() +
  geom_sf(data = salesPanel, aes(fill = permitCount), color = NA) +
  scale_fill_viridis(option = "magma",
                     limits = c(0, 20),
                     #trans = "log1p",
                     breaks = c(0, 5, 10, 20),
                     direction = 1) +
  labs(title = "Sales in Philadelphia",
       fill = "",
       caption = "Source: OpenDataPhilly") +
  guides(fill= guide_colorbar(barheight = 9, title.position = "bottom", label.position = "right")) +
  geom_text(data = salesPanel,
            aes(label = substr(period, 1, 4)),
            size = 8, x = -Inf, y = Inf, vjust = 1.5, hjust = -.1, colour = "black") +
    transition_manual(period) +
    mapTheme() +
    theme(legend.position = c(0.85, 0.2),
          legend.background = element_blank(),
          panel.border = element_blank(),
          panel.background = element_rect(fill = colors[2]),
          panel.grid = element_blank()
          )

animation

animate(animation, duration=20, renderer = gifski_renderer())

anim_save("sales", animation, duration=20, renderer = gifski_renderer())


```






