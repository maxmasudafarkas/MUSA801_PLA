---
title: "Philadelphia Legal Assistance: Adverse Possession"
author: "Adrian Leon, Max Masuda-Farkas, Gillian Xuezhu Zhao"
date: "28/01/2022"
output:
    html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---


# Philadelphia Legal Assistance

Smart Cities Practicum

## Introduction


```{r setup, include=FALSE}

# R Markdown options
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F, results = F, cache=T)

# LOAD PACKAGES

library(basemaps)
library(caret)
library(geojsonR)
library(gganimate)
library(gifski)
library(gridExtra)
library(kableExtra)
library(knitr)
library(lubridate)
library(mapview)
library(riem)
library(scales)
library(sf)
library(spdep)
library(tidycensus)
library(tidyverse)
library(tigris)
library(viridis)

# R options setup
options(scipen = 999)
options(tigris_class = "sf")

# additional functions from PPA book
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


# function shortcuts
g <- glimpse
m <- mapview
len <- length
st_c <- st_coordinates


# Aesthetics

colors <- c('#222222','#eeeeee')
palette <- c("#3f4238", "#b98b73", "#f6bd60", "#ff758f", "#2a9d8f")


```

```{r gillian settings}

# color scheme
# https://coolors.co/b98b73-cb997e-ddbea9-ffe8d6-d4c7b0-b7b7a4-a5a58d-6b705c-3f4238 

#               dark green, dark brown, highlight yellow, highlight pink, highlight blue


# ggplot map theme for us to build on
mapTheme_ggplot <- function() {
  theme(
    rect = element_rect(fill = "transparent") # this set the background transparent
    )
}


mapGuide_ggplot <- function() {
  guides(
    colour = guide_legend(override.aes = list(size=5)) # this set the size for the point on legend
    ) 
}

chartTheme_ggplot <- function() {
  theme(
    rect = element_rect(fill = "transparent"), # this set the background transparent
    axis.text = element_text(size=12),
    axis.title.x = element_text(size=12),
    axis.title.y = element_text(size=12),
  )
}


# save ggplot map configurations
mapSave_ggplot <- function(fileName) {
  ggsave(paste("visualizations/1st_presentation/", fileName, ".png", sep=""), #Gillian's path
         plot = last_plot(), dpi = 300, 
         width = 8, height = 5, units = "in", bg = "transparent")
}

chartSave_ggplot <- function(fileName) {
  ggsave(paste("visualizations/1st_presentation/", fileName, ".png", sep=""), #Gillian's path
         plot = last_plot(), dpi = 300, 
         width = 8, height = 5, units = "in", bg = "transparent")
}


```



## Base data

### A. Geographic boundaries

```{r data: base geometry}

# set CRS to Pennsylvania South NAD83 in meters
phlcrs <- 'EPSG:32129'


# get geometry for tracts in Philadelphia
phltracts <- 
  tigris::tracts(state = 42, county = 101) %>%
  dplyr::select(GEOID, geometry) %>%
  st_transform(st_crs(phlcrs))


# get geometry for the county of Philadelphia
phlcounty <-
  phltracts %>%
  st_union()


# set up the fishnet bins as the most granular unit of analysis
fishnet <- phlcounty %>%
  st_make_grid(.,
               cellsize = 250, 
               square = TRUE) %>%
  .[phlcounty] %>%                     # clip to Philadelphia County boundary
  st_sf() %>%
  mutate(uniqueID = rownames(.))


# Create a fishnet grid boundary of Philadelphia County
phlFishnet <- fishnet %>%
  st_union()

```





### B. Demographic

```{r data: ACS demographic}

# Get API key loaded locally
censusKey <-  read_file('../censusapikey.R')

# load census api key from local file
census_api_key(censusKey)

# set consulted year
year <- 2019

# get variables names and codes
acsVariableList <- load_variables(year, "acs5", cache = TRUE)

# set census variables to consult
censusVars <-
  c("B02001_001E", # Total population 
    "B11001_002E", # Total households
    "B02001_002E", # Total white population 
    "B19013_001E", # Median household income
    "B25003_001E") # Tenure of household

# Get the data
demographics <-
  get_acs(geography = "tract",
          variables = censusVars,
          year = year,
          state = 42,
          county = 101,
          geometry= T,
          output = "wide") %>%
  st_transform(st_crs(phlcrs)) %>%
  rename(totalPop = "B02001_001E",
         totalHHs = "B11001_002E",
         whitePop = "B02001_002E",
         medHHInc = "B19013_001E",
         tenureHH = "B25003_001E") %>%
  dplyr::select(-NAME, -starts_with("B"))%>%
  replace(is.na(.), 0) %>%
  mutate(pctWhite = ifelse(totalPop > 0, whitePop / totalPop, 0),
         pctTenur = ifelse(totalPop > 0, tenureHH / totalPop, 0)) %>%
  mutate(nhMajMin = ifelse(pctWhite > 0.5, 1, 0),
         nhIncome = ifelse(medHHInc > mean(.$medHHInc), 1, 0),
         nhTenure = ifelse(pctTenur > 0.5, 1, 0)) %>%
  dplyr::select(nhMajMin, nhIncome, nhTenure) %>%
  st_transform(st_crs(phlcrs))
  

# Create a mask for the majority minority census tracts fishnet cells
majminFishnet <- 
  demographics %>%
  filter(nhMajMin == 1) %>%
  st_union() %>%
  st_intersection(fishnet) %>%
  fishnet[.,] %>%
  st_union()


```







### C. Properties

[source]('https://www.opendataphilly.org/dataset/opa-property-assessments')


```{r data: OPA properties}

# Load properties from 1999 until now from the Office of Property Assessment.
# properties <- read_csv('https://opendata-downloads.s3.amazonaws.com/opa_properties_public.csv')

# OR local load
properties <- readRDS('properties.rds')

# Selected variables of interest
propertiesVars <-
  c("category_code",                  # KEEP ------------------------------------determines if it is VACANT LAND
    #"exterior_condition",             # KEEP ------------------------------------how the exterior appears based on observation.
    #"frontage",                       # MODEL
    #"location",                       # KEEP for JOIN check****
    "market_value",                   # KEEP ------------------------------------the certified market value of the property.
    #"off_street_open",                # UNNECESSARY
    "owner_1",                        # KEEP
    "owner_2",                        # KEEP
    "parcel_number",                  # KEEP to JOIN***
    #"parcel_shape",                   # MODEL
    #"registry_number",                # KEEP to JOIN
    "sale_date",                      # KEEP
    #"sale_price",                     # KEEP
    #"taxable_land",                   # MODEL
    #"topography",                     # MODEL
    "total_area",                     # KEEP
    #"unfinished",                     # UNNECESSARY
    "year_built",                     # KEEP
    "zoning",                         # KEEP
    "pin",                            # KEEP to JOIN ****
    "lat",                            # KEEP****
    "lng")                            # KEEP****


# Data wrangling
propertiesData <- properties %>%
  dplyr::select(propertiesVars) %>%
  filter(!is.na(lat), !is.na(lng)) %>%              
  st_as_sf(coords = c("lat","lng"), crs = 4326) %>%
  st_transform(st_crs(phlcrs)) %>%
  st_join(demographics)


# save locally
# saveRDS(properties, file = "properties.rds")

```

```{r fig.width= 8, fig.height= 8}


# All properties map
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = propertiesData, color = palette[1], size=0.02) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank(),
        )


```




## Supply-side data

### Vacant lots


From metadata:  "Input characteristics of the model are determined to be either positive or negative indicators of vacancy. A positive indicator has a tendency to signify vacancy (e.g., code violation issued by L+I). A negative indicator has a tendency to signify occupancy (e.g., OPA occupied property code). Individual indicators are weighted based on age of observation/record or other factors as determined by city department subject matter experts for a contributing dataset. Each indicator is also determined to represent a vacant lot or vacant building, as documented in the contributing dataset."

[source]('https://www.opendataphilly.org/dataset/vacant-property-indicators')


```{r data: vacant land}

# OpenDataPhilly Vacant Property Indicator - Lots
vacantLand <- read_csv('https://opendata.arcgis.com/datasets/19c35fb02d544a9bad0032b58268c9f9_0.csv')

# Select useful variables --- NO GEOMETRY
vacantLandVars <-
  c(#"ADDRESS",                        # KEEP for JOIN CHECK
    "BLDG_DESC",                      # KEEP ------------------------------------Building description from OPA
    "OPA_ID",                         # KEEP to JOIN****
    #"ZONINGBASEDISTRICT",             # KEEP***
    "LAND_RANK")                      # KEEP?

# Data wrangling
vacantLandData <- vacantLand %>%
  dplyr::select(vacantLandVars) %>%
  mutate(vacant = 'vacant')


# JOIN to propertiesData
# propertiesData <---> vacantLandData
vacantLandProps <- propertiesData %>%
  inner_join(vacantLandData, by=c('parcel_number'='OPA_ID'))

# save locally
# saveRDS(vacantLand, file = "vacantLand.rds")
saveRDS(vacantLandProps, file = "vacantLandProps.rds")

```






```{r fig.width= 8, fig.height= 8}

# Vacant Lots in properties map
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = propertiesData, color = palette[1], size=0.02) +
  geom_sf(data = vacantLandProps, color = palette[2], size=0.02) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank(),
        )
  
#mapSave_ggplot("vacantProperties")

```



```{r fig.width= 8, fig.height= 8}

# Jusr vacant Lots map
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = vacantLandProps, color = palette[1], size=0.02) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = "bottom",
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank(),
        )
  
#mapSave_ggplot("vacantProperties")

```




### Real Estate Tax Delinquencies

[source]('https://www.opendataphilly.org/dataset/property-tax-delinquencies')


```{r supply tax delinquencies}

# Real Estate Delinquencies from OpenData Philly:
delinquencies <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+real_estate_tax_delinquencies&filename=real_estate_tax_delinquencies&format=csv&skipfields=cartodb_id,the_geom,the_geom_webmercator')

# Variables - Tax Delinquencies (53 vars)
delinquenciesVars <-
  c("opa_number",                     # KEEP to JOIN****
    #"street_address",                 # KEEP to JOIN check****
    #"owner",                          # UNNECESSARY
    #"co_owner",                       # UNNECESSARY
    "total_due",                      # KEEP ------------------------------------The total amount owner owes.
    "is_actionable",                  # KEEP?*** --------------------------------Action can be taken against the delinquent property.
    "num_years_owed",                 # KEEP ***for adverse possession reference
    "most_recent_year_owed",          # KEEP for reference
    "oldest_year_owed",               # KEEP for reference
    "most_recent_payment_date",       # KEEP for reference
    #"year_of_last_assessment",        # KEEP for reference
    "total_assessment",               # KEEP for reference
    #"building_code",                  # ???? ------------------------------------Building codes describe the building.
    #"general_building_description",   # ???? ------------------------------------General description of how the building is used.
    #"building_category",              # ???? ------------------------------------Type of Building Group (residential, commercial, etc.).
    "sheriff_sale",                   # KEEP*** ---------------------------------Property is in the Sheriff Sale Process (any stage).
    "liens_sold_1990s",               # KEEP*** ---------------------------------Property was included in 1997 Lien Sale.
    "liens_sold_2015")                # KEEP*** ---------------------------------Property is included in Recent Lien Sales.


# Data wrangling
delinquenciesData <- delinquencies %>%
  dplyr::select(delinquenciesVars) %>%
  mutate(opa_number = sprintf("%09d", opa_number))


# JOIN to properties
# propertiesData <---> delinquenciesData
initialDate = '2017-01-01'
finalDate = '2021-12-31'

delinquenciesProps <- propertiesData %>%
  inner_join(delinquenciesData, by = c('parcel_number'='opa_number')) %>%
  # filter(sale_date >= initialDate & sale_date < finalDate) %>%
  st_sf()

# save locally
# saveRDS(delinquencies, file = "delinquencies.rds")

```


Of all vacant properties, how many are delinquent?

```{r fig.width= 8, fig.height= 8}

# map vacant properties (points)
delinquenciesVacantProps <-
  left_join(vacantLandProps,
            delinquenciesProps %>% st_drop_geometry() %>% mutate(delinquentStatus = 1),
            by = "parcel_number") %>%
  mutate(delinquentStatus = ifelse(is.na(delinquentStatus) == F, 1, 0),
         delinquentType = ifelse(liens_sold_1990s == T, 2, delinquentStatus), # delinquent type: 0 not, 1 yes, 2 us bank
         delinquentType = replace_na(delinquentType, 0))



# Map delinquent properties
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1], size = 0) + 
  geom_sf(data = delinquenciesVacantProps, 
          aes(color = factor(delinquentStatus)), 
          size = 0.02) +
  scale_color_manual("delinquent", values= c(palette[1], palette[2]), labels= c("no", "yes")) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        legend.key.size = unit(1,"line"),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        ) 

```

Where are these delinquencies concentrated?

```{r fig.width= 8, fig.height= 8}

# map vacant properties (fishnet)
delinquenciesVacantNet <- delinquenciesVacantProps %>%
  mutate(vacant = 1) %>%
  select(delinquentStatus, vacant) %>%
  aggregate(fishnet, sum) %>% 
  mutate(countDelinquent = replace_na(delinquentStatus, 0),
         vacant = replace_na(vacant, 0)) %>%
  select(-delinquentStatus)


# delinquencies heat map
ggplot() +
  geom_sf(data = phlFishnet, color = NA, fill = colors[1]) + 
  geom_sf(data = subset(delinquenciesVacantNet, vacant > 0), aes(fill = countDelinquent), color = NA, inherit.aes = FALSE) + 
  scale_fill_viridis(
    option = "mako",
    trans = "log1p",
    direction = 1) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.2),
        legend.title = element_text(size = 10, color = colors[1], hjust = 0.5),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid = element_blank(),
        )

#mapSave_ggplot("delinquentVacantProperties_fishnet")

```




```{r}

# trend of delinquencies # whether it is vacant or not, doesn't matter

delinquenciesProps %>%
  group_by(oldest_year_owed) %>%
  summarise(countProp = n()) %>%
  st_drop_geometry() %>% 
  ggplot(
    aes(x=oldest_year_owed, y=countProp)) + 
  geom_line(color = palette[2], size=1.5) + 
  xlab("year") +
  ylab("tax delinquent properties")

#chartSave_ggplot("delinquentTrend")

```



```{r}

# trend of delinquencies of vacant properties
delinquenciesVacantProps %>%
  group_by(oldest_year_owed) %>%
  summarise(countProp = n()) %>%
  st_drop_geometry() %>%
  ggplot(
    aes(x = oldest_year_owed, y = countProp)) + 
  geom_line(color = palette[2], size = 1.5) + 
  xlab("year") +
  ylab("tax delinquent vacant properties") +
  ylim(c(0, 1600)) 

#chartSave_ggplot("delinquentVacantTrend")
```







### US Bank Liens

```{r data: us bank liens}

# Client-provided US Bank Liens Data (as 'US Bank sharp')
# These are Liens that have been sold - UPDATE?
usBankLiens_0 <- read.csv("./data/usBank.csv") %>%
  dplyr::select(-X) %>%
  na.omit() %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326, agr = 'constant')


# US Bank Liens geocoded (by GILLIAN):
usBankLiens_1 <- read.csv("./data/usBankLiens_latlon.csv") %>%
  rename(lon = 'long') %>%
  filter(!is.na(lat), !is.na(lon)) %>% 
  st_as_sf(coords = c("lon","lat"), crs = 4269)  %>%
  filter(X != 16)                                                # TAKE out Mississippi geocode error


# US Bank Liens pending geocoding (with NAs):
usBankLiens_NA <- read.csv("./data/usBankLiens_latlonNA.csv") %>%
  rename(lon = 'long')


# visualize liens locations
m(usBankLiens_1, zcol='CALC_TOTAL')


```


```{r}

delinquenciesVacantProps %>%
  filter(delinquentStatus == 1) %>%
  group_by(liens_sold_1990s) %>%
  summarise(countUsBank = n()) %>%
  st_drop_geometry() %>%
  ggplot(aes(liens_sold_1990s, countUsBank, fill = factor(liens_sold_1990s))) + 
  geom_bar(position = "dodge", stat = "summary", fun = "mean") +
  scale_fill_manual(values = c(palette[3], palette[4]),
                    name="") +
  scale_x_discrete(name = "US bank lien", 
                   labels = c("no", "yes")) +
  ylab("properties") +
  theme(legend.position = "none")

#chartSave_ggplot("usbankBar")


```


```{r fig.width= 8, fig.height= 8}

# US Bank Liens comparison map

delinquenciesVacantProps %>%
  filter(delinquentType > 0) %>%
  ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = colors[1]) + 
  geom_sf(aes(color = factor(delinquentType)), 
          size = 0.02) +
  scale_color_manual("", values = c(palette[1], palette[2]),
                     labels= c("delinquent vacant", "US Bank lien")) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        )

#mapSave_ggplot("usbankVacantProperties")

```



### Real Estate Transfers

Real Estate Transfers Tax Documents

[source]('https://www.opendataphilly.org/dataset/real-estate-transfers')

Dataset description:

"Description	This is a summary of real estate transfer tax (RTT) documents. This table contains both raw source data as well as calculated/geocoded data, which are described below. Each row represents a distinct property involved in a RTT transaction document; all properties involved in a transaction share the same document_id. Please note that 918 transactions have been temporarily omitted while we address data integration issues with these records."


```{r data: transfers}

# OpenDataPhilly Endpoint of Property Assessment History:
# transfers <- read_csv('https://opendata-downloads.s3.amazonaws.com/rtt_summary.csv')
#transfers <- read_csv('https://opendata.arcgis.com/datasets/88e5bc291b834606bd49f6fd6dca226e_0.csv')

# OR load locally
transfers <- readRDS('transfers.rds')

# OpenDataPhilly - Transfers (48 variables)
transfersVars <- 
  c("document_type",                # KEEP*** -----------------------------------refers to type of Real Estate Transaction
    "display_date",                 # KEEP***
    "street_address",               # KEEP for JOIN check
    "grantors",                     # KEEP --------------------------------------seller (on deeds), or borrower (on mortgages)
    "grantees",                     # KEEP --------------------------------------buyer, recipient, new owner, or lien holder
    #"total_consideration",          # KEEP?** -----------------------------------good exchanged for the real estate (usually money)
    #"assessed_value",               # KEEP?** -----------------------------------assess value by OPA
    #"common_level_ratio",           # UNNECESSARY -------------------------------fair market : assessment values ratio
    "fair_market_value",            # KEEP?** -----------------------------------assessment value by common level ratio
    #"receipt_date",                 # UNNECESSARY - display_date is used
    #"recording_date",               # UNNECESSARY - display_date is used
    #"document_date",                # UNNECESSARY - display_date is used
    "opa_account_num",              # KEEP****to join
    "property_count")               # KEEP --------------------------------------Number of properties in document


# Data wrangling
transfersData <- transfers %>%
  dplyr::select(transfersVars) %>%
  filter(!is.na(opa_account_num)) %>%
  filter(document_type %in% c('DEED',
                              'DEED LAND BANK',
                              'DEED MISCELLANEOUS',
                              'DEED MISCELLANEOUS TAXABLE',
                              'DEED OF CONDEMNATION',
                              'DEED SHERIFF'))

# JOIN to properties
# propertiesData <---> transfersData

# if a parcel_number has multiple deeds, I manipulated data to shift deed sheriff first
# so distinct() will grab deed sheriff and neglect others
transfersProps <- propertiesData %>%
  inner_join(transfersData, by= c('parcel_number'='opa_account_num'))%>% 
  mutate(document_type = factor(document_type,
                                labels(c("DEED SHERIFF" = 1,
                                         "DEED" = 2,
                                         "DEED MISCELLANEOUS" = 3,
                                         "DEED OF CONDEMNATION" = 4,
                                         "DEED LAND BANK" = 5,
                                         "DEED MISCELLANEOUS TAXABLE" = 6)))) %>%
  arrange(parcel_number, document_type) %>%
  distinct(parcel_number, .keep_all = TRUE)
  
# save locally
# saveRDS(transfers, file = "transfers.rds")

```



### Sheriff Sales

```{r fig.width= 8, fig.height= 8}

# sheriff sales after 2021 from client
sheriffSales_21 <- read_csv('./data/sheriffSales_21.csv') %>%
  distinct(OPA, .keep_all=TRUE)                                                # remove duplicates

# Sheriff Sales before 2021 from real estate transfers data (completed)
sheriffSales_20 <-
  transfersProps %>%
  filter(document_type == "DEED SHERIFF") 


# join all sheriff sales info we have together
## sheriff sales data from transfers
sheriffProps <-
  left_join(
    delinquenciesVacantProps,
    st_drop_geometry(sheriffSales_20),
    by = "parcel_number") %>%
  distinct(parcel_number, .keep_all = T) %>%
  merge(., sheriffSales_21,
        by.x = "parcel_number", by.y = "OPA", all.x = T, no.dups = T) %>%
  mutate(pastSheriffSale = ifelse(document_type == "DEED SHERIFF", 1, 0)) %>%   #  past records only
  mutate(pastSheriffSale = replace_na(pastSheriffSale, 0)) %>%
  mutate(futureSheriffSale = ifelse(document_type == "DEED SHERIFF" | is.na(Status) == F | sheriff_sale == "Y", 1, 0)) %>% # future
  mutate(futureSheriffSale = replace_na(futureSheriffSale, 0)) %>%
  mutate(allSheriffSales = ifelse(pastSheriffSale == 1 | futureSheriffSale == 1, 1, 0),
         sheriffSaleYear = year(as.Date(display_date))) 


# Plot sheriff sales
ggplot() +
  geom_sf(data = phlcounty, color = NA, fill = "#222222") + 
  geom_sf(data = subset(sheriffProps, delinquentStatus == 1), 
          aes(color = factor(allSheriffSales)), 
          size = 0.02) +
  scale_color_manual("", values= c(palette[1], palette[2]),
                     labels= c("vacant delinquent", "sheriffs sale")) +
  mapTheme() +
  theme(axis.text.x = element_blank(),
        legend.position = c(0.85, 0.15),
        legend.background = element_blank(),
        legend.text = element_text(size=8),
        panel.border = element_blank(),
        panel.background = element_rect(fill = colors[2]),
        panel.grid.major = element_blank()
        )

```

>>> Is the drop in the chart below because we're missing or have inconsistent data?


```{r}

# TO TABLE
# trend of sheriff's sale 
# calculate how many sheriff sale for delinquent vacant properties 
sheriffProps %>%
  group_by(allSheriffSales) %>%
  summarise(countSheriffSale = n()) %>%
  st_drop_geometry()


# plot a chart of sheriff sales
sheriffProps %>%
  filter(delinquentStatus == 1) %>%
  group_by(pastSheriffSale, sheriffSaleYear) %>%
  summarise(countSheriffSale = n()) %>%
  st_drop_geometry() %>%
  filter(pastSheriffSale == 1) %>%
  ggplot(aes(x = as.numeric(sheriffSaleYear), y= countSheriffSale)) + 
  geom_vline(xintercept = 2017, color = palette[5], size=1) +
  geom_line(color = palette[3], size=1.5) + 
  xlab("year") +
  scale_x_continuous(
    breaks = seq(from = 1999, to = 2021, by = 2),
    limits = c(1999, 2021)) +
  ylab("sheriff's sales") +
  geom_text(x = 2017, y = 300, label = "", angle = 0)

#chartSave_ggplot("sheriffSaleTrend")


```










## Demand-side data

### L&I Building and Zoning Permits

[source]('https://www.opendataphilly.org/dataset/licenses-and-inspections-building-permits')

```{r data: permits}

# Load PERMITS data from OpenDataPhilly's Carto API
# permits <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*,+ST_Y(the_geom)+AS+lat,+ST_X(the_geom)+AS+lng+FROM+permits&filename=permits&format=csv&skipfields=cartodb_id')

# OR local load
permits <- readRDS('permits.rds')


# List the permit data set variables needed
permitsVars <-
  c('parcel_id_num',                 # KEEP for JOIN
    'permittype',                    # KEEP*****
    'permitdescription',             # KEEP for reference
    #'commercialorresidential',        # MAYBE
    'typeofwork',                    # KEEP****
    #'approvedscopeofwork',           # UNNECESSARY - detailed description
    'permitissuedate',               # KEEP***
    'status',                        # KEEP
    'applicanttype',                 # MAYBE
    #'contractor[...]',               # UNNECESSARY
    'opa_account_num',               # KEEP for JOIN****
    #'address',                       # KEEP for JOIN check
    #'unit_type',                     # UNNECESSARY
    'lng','lat'
    #'geometry'
    )

# EXAMINE VARIABLES
# permittype
permitTypes <- as.data.frame(table(permits$permittype))

# select permittyoe
permitCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING',                 #   11187   # "2015-12-02" to NOW ("2022-01-29")
    'ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING'               #    7617   # "2007-01-02" to "2020-03-12"
    )

# Old categories
permitCatsA <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING')              #    7617   # "2007-01-02" to "2020-03-12"

# New categories
permitCatsB <- 
  c('BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Building categories
permitBuildingCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING')   #   15909   # "2015-01-06" to NOW ("2022-01-29")

# Zoning categories
permitZoningCats <- 
  c('ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING',              #    7617   # "2007-01-02" to "2020-03-12"
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Data wrangling ONE
# Filter data with PERMIT TYPES (building or zoning)
permitsData <- permits %>%
  dplyr::select(permitsVars) %>%
  filter(permittype %in% permitZoningCats) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = phlcrs) 

# type of work across SELECTED categories (48):
permitTypesOfWork <- as.data.frame(table(permitsData$typeofwork)) 

# All categories
permitTypeOfWorkCats <- 
  c(#'ADD',                                              #   1665 ***OLD ***ZONING {New construction attached or added to existing}
    #'ADDITION AND/OR ALTERATION',                       #  17051 ***NEW ***BUILDING (6290)  ***RESIDENTIAL BUILDING (10761)
    #'CHANGE OF USE',                                    #   3046 ***NEW ***ZONING {General change of use}
    'COMBINED LOT LINE RELOCATION AND NEW DEVELOPMENT', #    313 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'COMDEM',                                           #   1163 ***OLD ***ZONING {Complete demolition}
    'ENTIRE',                                           #   2910 ***OLD ***ZONING (-2890) ***BUILDING {Entire structure}
    'ENTSTR',                                           #   3638 ***OLD ***ZONING
    'FULL DEMOLITION',                                  #    644 ***NEW ***ZONING {Full demolition}
    'LOT LINE RELOCATION',                              #    317 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'LOTLIN',                                           #   2527 ***OLD ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'NEW CONSTRUCTION',                                 #<- 6292 ***NEW ***BUILDING (1812) ***RESIDENTIAL BUILDING (4480)
    'NEW CONSTRUCTION (SHELL ONLY)',                    #<-   19 ***NEW ***BUILDING
    #'NEW CONSTRUCTION (STAND ALONE)',                   #<-   48 ***NEW ***RESIDENTIAL BUILDING
    'NEW CONSTRUCTION, ADDITION, GFA CHANGE',           #<- 4986 ***NEW ***ZONING {New construction attached or added to existing}
    'NEWCON'#                                           #<- 5539 ***OLD ***ZONING (-3) ***BUILDING {New construction of structure}
    #'PARTCH',                                           #   3317 ***OLD ***ZONING {Change in use}
    #'SFADD',                                            #   3149 ***OLD ***ZONING {Add square footage to existing}
    )
    
# Filter data with PERMIT TYPES (building or zoning)
permitsZoningData <- permitsData %>%
  filter(typeofwork %in% permitTypeOfWorkCats)


# JOIN to properties
# permitsZoningData <---> propertiesData
permitsProps <- propertiesData %>%
  inner_join(st_drop_geometry(permitsZoningData),  by = c('parcel_number'='opa_account_num'))

# permits by quarter by fishnet cell
permitsNet <- permitsProps %>%
  st_join(fishnet, left=F) %>%
  mutate(year = year(permitissuedate),
         month = month(permitissuedate),
         quarter = case_when(
           month %in% c(1, 2, 3) ~ 1,
           month %in% c(4, 5, 6) ~ 2,
           month %in% c(7, 8, 9) ~ 3,
           month %in% c(10, 11, 12) ~ 4)) %>%
  mutate(period = paste(year, quarter, sep='-')) %>%
  group_by(period, uniqueID) %>%
  summarize(permitCount = sum(n())) %>%
  st_drop_geometry()

# random cross validation ID (out of 100) for later use
# mutate(uniqueID = rownames(.)) %>%
# mutate(cvID = sample(round(nrow(fishnet)/24), size=nrow(fishnet), replace=T)) 

# create empty panel with all possible time/space combinations by fishnet grids
basePanel <- 
  expand.grid(period = unique(permitsNet$period), 
              uniqueID = unique(fishnet$uniqueID))

# join panel to fishnet geometry
permitsPanel <- 
  permitsNet %>%
  right_join(basePanel) %>% 
  replace(is.na(.), 0) %>%
  left_join(fishnet) %>%
  st_sf()

# save locally
# saveRDS(permits, file = "permits.rds")

```




### Permits in the last 15 years

```{r data: permit issue evolution A, fig.width= 8, fig.height= 8}

# Create Animation
animation <- 
  ggplot() +
  geom_sf(data = permitsPanel, aes(fill = permitCount), color = NA) +
  scale_fill_viridis(option = "magma",
                     limits = c(0, 20),
                     trans = "log1p",
                     breaks = c(0, 5, 10, 20),
                     direction = 1) +
  labs(title = "Zoning permits issued in Philadelphia",
       fill = "",
       caption = "Source: OpenDataPhilly") +
  guides(fill= guide_colorbar(barheight = 9, title.position = "bottom", label.position = "right")) +
  geom_text(data = permitsPanel,
            aes(label = substr(period, 1, 4)),
            size = 8, x = -Inf, y = Inf, vjust = 1.5, hjust = -.1, colour = "black") +
    transition_manual(period) +
    mapTheme() +
    theme(legend.position = c(0.85, 0.2),
          legend.background = element_blank(),
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#eeeeee"),
          panel.grid = element_blank()
          )

animation

anim_save("testPLA.gif", animation)

```




```{r data: permits issue change: 5 years A, fig.width= 12, fig.height= 8}

# classify zoning permits by five-year periods
permitsLustrums <- 
  permitsPanel %>%
  mutate(year = as.integer(substr(period, 1,4)),
         lustrum = case_when(
           year %in% seq(2007, 2011) ~ '2007-2011',
           year %in% seq(2012, 2016) ~ '2012-2016',
           year %in% seq(2017, 2021) ~ '2017-2021'
         )) %>%
  filter(year != '2022') %>%
  dplyr::select(-period, -year) %>%
  group_by(lustrum, uniqueID) %>%
  summarize(permitCount = sum(permitCount))


# side-by-side five-year period zoning permits
permitsLustrums %>%
  ggplot() +
  geom_sf(aes(fill = permitCount), color = NA) +
  scale_fill_viridis(
    option = "magma",
    limits = c(0,120),
    trans = "log1p",
    breaks = c(0,30,60,120),
    direction = 1) +
  labs(
    title = "Zoning permits issued in Philadelphia",
    fill = "number of permits",
    caption = "Source: OpenDataPhilly") +
  guides(
    size = F,
    fill= guide_colorbar(barwidth = 21, title.position = "top")) +
  facet_wrap(~lustrum, ncol = 3) +
  mapTheme() +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    panel.border = element_blank(),
    panel.background = element_rect(fill = "#eeeeee"),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "#eeeeee"),
    strip.text.x = element_text(size = 12, color = '#222222', hjust=0.01)
    )

```


```{r data: permits issue change: 5 years B, fig.width= 12, fig.height= 8}

# side-by-side five-year period zoning permits
permitsLustrums %>%
  ggplot() +
  geom_sf(aes(fill = permitCount), color = NA) +
  scale_fill_viridis(
    option = "magma",
    limits = c(0,120),
    trans = "log1p",
    breaks = c(0,30,60,120),
    direction = 1) +
  labs(
    title = "Zoning permits issued in Philadelphia",
    fill = "number of permits",
    caption = "Source: OpenDataPhilly") +
  guides(
    size = F,
    fill= guide_colorbar(barwidth = 21, title.position = "top")) +
  geom_sf(data = majminFishnet, fill = '#ffffff', color = '#eeeeee', alpha = 0.2) +
  geom_sf(data = phlFishnet, fill = NA, colour = "#222222") +
  facet_wrap(~lustrum, ncol = 3) +
  mapTheme() +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    panel.border = element_blank(),
    panel.background = element_rect(fill = "#eeeeee"),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "#eeeeee"),
    strip.text.x = element_text(size = 12, color = '#222222', hjust=0.01)
    )

```


```{r data: permits issue change: 5 years C, fig.width= 12, fig.height= 8}

# side-by-side five-year period zoning permits
permitsLustrums %>%
  ggplot() +
  geom_sf(aes(fill = permitCount), color = NA) +
  scale_fill_viridis(
    option = "magma",
    limits = c(0,120),
    trans = "log1p",
    breaks = c(0,30,60,120),
    direction = 1) +
  labs(
    title = "Zoning permits issued in Philadelphia",
    fill = "number of permits",
    caption = "Source: OpenDataPhilly") +
  guides(
    size = F,
    fill= guide_colorbar(barwidth = 21, title.position = "top")) +
  geom_sf(data = majminFishnet, fill = '#eeeeee', color = '#eeeeee', alpha= 1) +
  geom_sf(data = phlFishnet, fill = NA, colour = "#222222") +
  facet_wrap(~lustrum, ncol = 3) +
  mapTheme() +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    panel.border = element_blank(),
    panel.background = element_rect(fill = "#eeeeee"),
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "#eeeeee"),
    strip.text.x = element_text(size = 12, color = '#222222', hjust=0.01)
    )

```





## Neighborhood effects

```{r fig.width=12, fig.height=6}

# set color palette
color1 <- "#00c462" 
color2 <- "#009e69"

# define function
getNhMajMin <-
  function(dataframe, name) {
    dataframe %>%
      group_by(nhMajMin) %>%
      summarize(nhCount = sum(n())) %>%
      na.omit() %>%
      mutate(nhMajMin = c('non-white','white'),
             dataset = name) %>%
      st_drop_geometry() 
  }

# put together and ggplot
grid.arrange(
  rbind(
    getNhMajMin(propertiesData, 'properties'),
    getNhMajMin(vacantLandProps, 'vacantLand'),
    getNhMajMin(delinquenciesProps, 'delinquencies'),
    getNhMajMin(permitsProps, 'permits')) %>%
    mutate(factor = factor(dataset, levels = c("properties","vacantLand","delinquencies","permits"))) %>%
    #filter(dataset != 'properties') %>%
    ggplot(aes(nhMajMin, nhCount, fill = nhMajMin)) + 
    geom_bar(stat = "identity", width = .8) +
    scale_fill_manual(values = c(color1, color2)) +
    labs(title="Neighborhood effects",
         subtitle = "Number of properties by Majority racial composition",
         x = "",
         y = "properties") +
    geom_text(aes(label = nhMajMin, color = nhMajMin), vjust = -.5) +
    scale_colour_manual(values=c(color1, color2)) +
    facet_wrap(~factor, ncol = 4, strip.position = "bottom") +
    plotTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = "none",
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#ffffff"),
          panel.grid.major.x = element_blank(),
          strip.background = element_rect(fill = "#ffffff"),
          strip.text.x = element_text(size = 16, color = '#222222', hjust=0.05)
          ),
  demographics %>%
    dplyr::select(nhMajMin) %>%
    mutate(nhMajMin = case_when(
      nhMajMin == 0 ~ 'non-white',
      nhMajMin == 1 ~ 'white')) %>%
    ggplot() +
    geom_sf(aes(fill = nhMajMin), color = NA) +
    scale_fill_manual(values = c(color1, color2)) +
    mapTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = "none",
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#ffffff"),
          panel.grid.major.x = element_blank(),
          ),
  ncol=2,
  widths=c(3,1))


```



```{r fig.width=12, fig.height=6}

# define function
getNhIncome <-
  function(dataframe, name) {
    dataframe %>%
      group_by(nhIncome) %>%
      summarize(nhCount = sum(n())) %>%
      na.omit() %>%
      mutate(nhIncome = c('Below','Above'),
             dataset = name) %>%
      mutate(nhIncome = factor(nhIncome, levels = c('Below', 'Above'))) %>%
      st_drop_geometry() 
  }

# put together and ggplot with a map
grid.arrange(
    rbind(
      getNhIncome(propertiesData, 'properties'),
      getNhIncome(vacantLandProps, 'vacantLand'),
      getNhIncome(delinquenciesProps, 'delinquencies'),
      getNhIncome(permitsProps, 'permits')) %>%
      mutate(factor = factor(dataset, levels = c("properties","vacantLand","delinquencies","permits"))) %>%
      #filter(dataset != 'properties') %>%
      ggplot(aes(nhIncome, nhCount, fill = nhIncome)) + 
      geom_bar(stat = "identity", width = .8) +
      scale_fill_manual(values = c(color1, color2)) +
      labs(title="Neighborhood effects",
           subtitle = "Number of properties by Relation of Census Tract Median to County Average Household Income",
           x = "",
           y = "properties") +
      geom_text(aes(label = nhIncome, color = nhIncome), vjust = -.5) +
      scale_colour_manual(values=c(color1, color2)) +
      facet_wrap(~factor, ncol = 4, strip.position = "bottom") +
      plotTheme() +
      theme(axis.text.x = element_blank(),
            legend.position = "none",
            panel.border = element_blank(),
            panel.background = element_rect(fill = "#ffffff"),
            panel.grid.major.x = element_blank(),
            strip.background = element_rect(fill = "#ffffff"),
            strip.text.x = element_text(size = 16, color = '#222222')
            ),
    demographics %>%
      dplyr::select(nhIncome) %>%
      mutate(nhIncome = case_when(
        nhIncome == 0 ~ 'Above',
        nhIncome == 1 ~ 'Below')) %>%
      ggplot() +
      geom_sf(aes(fill = nhIncome), color = NA) +
      scale_fill_manual(values = c(color1, color2)) +
      mapTheme() +
      theme(axis.text.x = element_blank(),
            legend.position = "none",
            panel.border = element_blank(),
            panel.background = element_rect(fill = "#ffffff"),
            panel.grid.major.x = element_blank(),
            strip.background = element_rect(fill = "#ffffff"),
            strip.text.x = element_text(size = 16, color = '#222222', hjust=0.05)
            ),
    ncol = 2,
    widths = c(3, 1))

```


```{r fig.width=12, fig.height=6}

# define function
getNhTenure <-
  function(dataframe, name) {
    dataframe %>%
      group_by(nhTenure) %>%
      summarize(nhCount = sum(n())) %>%
      na.omit() %>%
      mutate(nhTenure = c('Not-owner', 'Owner'),
             dataset = name) %>%
      #mutate(nhTenure = factor(nhTenure, levels = c('Not-owner', 'Owner'))) %>%
      st_drop_geometry() 
  }

# put together and ggplot
grid.arrange(
  rbind(
    getNhTenure(propertiesData, 'properties'),
    getNhTenure(vacantLandProps, 'vacantLand'),
    getNhTenure(delinquenciesProps, 'delinquencies'),
    getNhTenure(permitsProps, 'permits')) %>%
    mutate(factor = factor(dataset, levels = c("properties","vacantLand","delinquencies","permits"))) %>%
    #filter(dataset != 'properties') %>%
    ggplot(aes(nhTenure, nhCount, fill = nhTenure)) + 
    geom_bar(stat = "identity", width = .8) +
    scale_fill_manual(values = c(color1, color2)) +
    labs(title="Neighborhood effects",
         subtitle = "Number of properties by Ammount of Property Ownership",
         x = "",
         y = "properties") +
    geom_text(aes(label = nhTenure, color = nhTenure), vjust = -.5) +
    scale_colour_manual(values=c(color1, color2)) +
    facet_wrap(~factor, ncol = 4, strip.position = "bottom") +
    plotTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = "none",
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#ffffff"),
          panel.grid.major.x = element_blank(),
          strip.background = element_rect(fill = "#ffffff"),
          strip.text.x = element_text(size = 16, color = '#222222')
          ),
  demographics %>%
    dplyr::select(nhTenure) %>%
    mutate(nhTenure = case_when(
      nhTenure == 0 ~ 'Non-owner',
      nhTenure == 1 ~ 'Owner')) %>%
    ggplot() +
    geom_sf(aes(fill = nhTenure), color = NA) +
    scale_fill_manual(values = c(color1, color2)) +
    mapTheme() +
    theme(axis.text.x = element_blank(),
          legend.position = "none",
          panel.border = element_blank(),
          panel.background = element_rect(fill = "#ffffff"),
          panel.grid.major.x = element_blank(),
          ),
    ncol = 2,
    widths = c(3, 1))

```













