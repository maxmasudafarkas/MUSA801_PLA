---
title: "Philadelphia Legal Assistance: Adverse Possession"
author: "Adrian Leon, Max Masuda-Farkas, Gillian Xuezhu Zhao"
date: "28/01/2022"
output:
    html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---


# Philadelphia Legal Assistance

## Smart Cities Practicum

```{r setup, include=FALSE}

# R Markdown options
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F, results = F, cache=T)

# LOAD PACKAGES
library(sf)
library(riem)
library(caret)
library(spdep)
library(knitr)
library(gifski)
library(tigris)
library(mapview)
library(geojsonR)
library(tidyverse)
library(lubridate)
library(gganimate)
library(gridExtra)
library(kableExtra)

# R options setup
options(scipen = 999)
options(tigris_class = "sf")

# additional functions from PPA book
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


# function shortcuts
g <- glimpse
m <- mapview
len <- length
st_c <- st_coordinates


```




### Supply-side data

#### S1: US Bank Liens

```{r supply-side data}

# Client-provided US Bank Liens Data (as 'US Bank sharp')
# These are Liens that have been sold - UPDATE?
usBankLiens_0 <- read.csv("./data/usBank.csv") %>%
  dplyr::select(-X) %>%
  na.omit() %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326, agr = 'constant')


# US Bank Liens geocoded (by GILLIAN):
usBankLiens_1 <- read.csv("./data/usBankLiens_latlon.csv") %>%
  rename(lon = 'long') %>%
  filter(!is.na(lat), !is.na(lon)) %>% 
  st_as_sf(coords = c("lon","lat"), crs = 4269)  %>%
  filter(X != 16)                                                # TAKE out Mississippi geocode error


# US Bank Liens pending geocoding (with NAs):
usBankLiens_NA <- read.csv("./data/usBankLiens_latlonNA.csv") %>%
  rename(lon = 'long')


# visualize liens locations
m(usBankLiens_1, zcol='CALC_TOTAL')


```


#### S2: Vacant lots


```{r supply vacant land}

# OpenDataPhilly Vacant Property Indicator - Lots
vacantLand <- read_csv('https://opendata.arcgis.com/datasets/19c35fb02d544a9bad0032b58268c9f9_0.csv')

g(vacantLand)


```


#### S3: Real Estate Tax Delinquencies

```{r supply tax delinquencies}

# Real Estate Delinquencies from OpenData Philly:
delinquencies <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+real_estate_tax_delinquencies&filename=real_estate_tax_delinquencies&format=csv&skipfields=cartodb_id,the_geom,the_geom_webmercator')


# Variables - Tax Delinquencies (53 vars)
delinquenciesVars <-
  c(#"objectid",                       # UNNECESSARY
    "opa_number",                     # KEEP ***to join***
    #"street_address",                 # UNNECESSARY
    #"zip_code",                       # UNNECESSARY
    #"zip_4",                          # UNNECESSARY
    #"unit_type",                      # UNNECESSARY
    #"unit_num",                       # UNNECESSARY
    "owner",                          # KEEP for reference
    "co_owner",                       # KEEP for reference
    #"principal_due",                  # UNNECESSARY -----------------------------The amount of principal due.
    #"penalty_due",                    # UNNECESSARY -----------------------------The penalty amount due.
    #"interest_due",                   # UNNECESSARY -----------------------------The amount of interest due.
    #"other_charges_due",              # UNNECESSARY -----------------------------Additional charges owner owes.
    "total_due",                      # KEEP ------------------------------------The total amount owner owes.
    "is_actionable",                  # KEEP?*** --------------------------------Action can be taken against the delinquent property.
    #"payment_agreement",              # UNNECESSARY -----------------------------The property owner is in a payment agreement.
    "num_years_owed",                 # KEEP ***for adverse possession reference
    "most_recent_year_owed",          # KEEP for reference
    "oldest_year_owed",               # KEEP for reference
    "most_recent_payment_date",       # KEEP for reference
    "year_of_last_assessment",        # KEEP for reference
    "total_assessment",               # KEEP for reference
    "taxable_assessment",             # KEEP for reference
    #"mailing_address",                # UNNECESSARY
    #"mailing_city",                   # UNNECESSARY
    #"mailing_state",                  # UNNECESSARY
    #"mailing_zip",                    # UNNECESSARY
    #"return_mail",                    # UNNECESSARY
    "building_code",                  # ???? ------------------------------------Building codes describe the building.
    #"detail_building_description",    # ???? ------------------------------------Description of the building code.
    #"general_building_description",   # ???? ------------------------------------General description of how the building is used.
    "building_category",              # ???? ------------------------------------Type of Building Group (residential, commercial, etc.).
    "coll_agency_num_years",          # ???? ------------------------------------TO COLLECTION AGENCY
    "coll_agency_most_recent_year",   # ???? ------------------------------------TO COLLECTION AGENCY
    "coll_agency_oldest_year",        # ???? ------------------------------------TO COLLECTION AGENCY
    "coll_agency_principal_owed",     # ???? ------------------------------------TO COLLECTION AGENCY
    "coll_agency_total_owed",         # ???? ------------------------------------TO COLLECTION AGENCY
    #"exempt_abatement_assessment",    # UNNECESSARY -----------------------------The amount excluded from the tax base.
    #"homestead_value",                # UNNECESSARY -----------------------------Amount of Homestead Exemption.
    "net_tax_value_after_homestead",  # ???? ------------------------------------The net tax value after the homestead exemption.
    #"agreement_agency",               # UNNECESSARY -----------------------------Either "TIPS","lbr","grb","LAW" 
    #"sequestration_enforcement",      # UNNECESSARY -----------------------------If the property is a rental, the city can collect rent
    "bankruptcy",                     # UNNECESSARY -----------------------------Active bankruptcy
    #"years_in_bankruptcy",            # UNNECESSARY 
    #"most_recent_bankrupt_year",      # UNNECESSARY
    #"oldest_bankrupt_year",           # UNNECESSARY
    #"principal_sum_bankrupt_years",   # UNNECESSARY
    #"total_amount_bankrupt_years",    # UNNECESSARY
    "sheriff_sale",                   # KEEP*** ---------------------------------Property is in the Sheriff Sale Process (any stage).
    "liens_sold_1990s",               # KEEP*** ---------------------------------Property was included in 1997 Lien Sale.
    "liens_sold_2015",                # KEEP*** ---------------------------------Property is included in Recent Lien Sales.
    #"assessment_under_appeal",        # UNNECESSARY -----------------------------the owner has appealed the assessment.
    "year_month")                     # year$month >>>> Unlisted in metadata



delinquenciesData <- delinquencies %>%
  dplyr::select(delinquenciesVars)



head(z)

```






#### P1: Parcels dataset

```{r supply all parcels}

# GET directly from the WEB
## AS GeoJSON st_read('https://opendata.arcgis.com/datasets/1c57dd1b3ff84449a4b0e3fb29d3cafd_0.geojson')


# Philadelphia Department of Registration Parcel data
parcels <- st_read("C:/Users/golet/UPENN/MUSA_801/data/DOR_Parcel/DOR_Parcel.shp")

# visualize  
z <- head(parcels, n=10000)
m(z)





```

### P2: Properties dataset

```{r supply all properties description}

# Load properties from 99 until now from ODP.
properties <- read_csv('https://opendata-downloads.s3.amazonaws.com/opa_properties_public.csv')


# Selected variables of interest
propertiesVars <-
  c(#"objectid",                       # UNNECESSARY
    #"assessment_date",                # UNNECESSARY
    #"basements",                      # UNNECESSARY
    #"beginning_point",                # UNNECESSARY
    #"book_and_page",                  # UNNECESSARY
    #"building_code",                  # UNNECESSARY
    #"building_code_description",      # UNNECESSARY
    "category_code",                  # KEEP ------------------------------------determines if it is VACANT LAND
    "category_code_description",      # KEEP ------------------------------------determines if it is VACANT LAND
    #"census_tract",                   # UNNECESSARY
    #"central_air",                    # UNNECESSARY
    #"cross_reference",                # UNNECESSARY
    #"date_exterior_condition",        # UNNECESSARY
    #"depth",                          # UNNECESSARY
    #"exempt_building",                # UNNECESSARY
    #"exempt_land",                    # UNNECESSARY
    "exterior_condition",             # KEEP ------------------------------------how the exterior appears based on observation.
    #"fireplaces",                     # UNNECESSARY
    #"frontage",                       # UNNECESSARY
    #"fuel",                           # UNNECESSARY
    #"garage_spaces",                  # UNNECESSARY
    #"garage_type",                    # UNNECESSARY
    #"general_construction",           # UNNECESSARY
    #"geographic_ward",                # UNNECESSARY
    #"homestead_exemption",            # UNNECESSARY
    #"house_extension",                # UNNECESSARY
    #"house_number",                   # UNNECESSARY
    #"interior_condition",             # UNNECESSARY
    #"location",                       # UNNECESSARY
    #"mailing_address_1",              # UNNECESSARY
    #"mailing_address_2",              # UNNECESSARY
    #"mailing_care_of",                # UNNECESSARY
    #"mailing_city_state",             # UNNECESSARY
    #"mailing_street",                 # UNNECESSARY
    #"mailing_zip",                    # UNNECESSARY
    "market_value",                   # KEEP ------------------------------------the certified market value of the property.
    #"market_value_date",              # UNNECESSARY
    #"number_of_bathrooms",            # UNNECESSARY
    #"number_of_bedrooms",             # UNNECESSARY
    #"number_of_rooms",                # UNNECESSARY
    #"number_stories",                 # UNNECESSARY
    #"off_street_open",                # UNNECESSARY
    #"other_building",                 # UNNECESSARY
    "owner_1",                        # KEEP?
    "owner_2",                        # KEEP?
    "parcel_number",                  # KEEP***
    #"parcel_shape",                   # UNNECESSARY
    #"quality_grade",                  # UNNECESSARY
    "recording_date",                 # KEEP? -----------------------------------date the deed was presented to records.
    #"registry_number",                # UNNECESSARY
    "sale_date",                      # KEEP
    "sale_price",                     # KEEP
    #"separate_utilities",             # UNNECESSARY
    #"sewer",                          # UNNECESSARY
    #"site_type",                      # UNNECESSARY
    #"state_code",                     # UNNECESSARY
    #"street_code",                    # UNNECESSARY
    #"street_designation",             # UNNECESSARY
    #"street_direction",               # UNNECESSARY
    #"street_name",                    # UNNECESSARY
    #"suffix",                         # UNNECESSARY
    #"taxable_building",               # UNNECESSARY
    #"taxable_land",                   # UNNECESSARY
    #"topography",                     # UNNECESSARY
    "total_area",                     # KEEP
    #"total_livable_area",             # UNNECESSARY
    #"type_heater",                    # UNNECESSARY
    "unfinished",                     # KEEP?
    #"unit",                           # UNNECESSARY
    #"utility",                        # UNNECESSARY
    #"view_type",                      # UNNECESSARY
    "year_built",                     # KEEP?
    #"year_built_estimate",            # UNNECESSARY
    #"zip_code",                       # UNNECESSARY
    "zoning",                         # KEEP
    "pin",                            # KEEP?
    "lat",                            # KEEP****
    "lng")                            # KEEP****

# Wrangle the data
propertiesData <- properties %>%
  dplyr::select(propertiesVars)




```








### Demand-side data

#### D1: L&I Building and Zoning Permits

```{r demand data permits}

# Load PERMITS data from OpenDataPhilly's Carto API
permits <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*,+ST_Y(the_geom)+AS+lat,+ST_X(the_geom)+AS+lng+FROM+permits&filename=permits&format=csv&skipfields=cartodb_id')

# objectid                  UNNECESSARY
# permitnumber              UNNECESSARY
# addressobjectid           UNNECESSARY
# parcel_id_num             KEEP for referencing parcels
# permittype                MAYBE
# permitdescription         UNNECESSARY
# commercialorresidential   filter just RESIDENTIAL properties?
# typeofwork                MAYBE
# approvedscopeofwork       UNNECESSARY
# permitissuedate           *KEEP
# status                    KEEP
# applicanttype             MAYBE
# contractor[...]           UNNECESSARY
# mostrecentinsp            UNNECESSARY
# opa_account_num           UNNECESSARY
# address                   KEEP
# unit_type                 MAYBE
# unit_num                  MAYBE keep and match with address?
# zip                       UNNECESSARY
# censustract               UNNECESSARY
# council_district          UNNECESSARY
# opa_owner                 Office of Property Assessment's ownership from the current deed for the property.
# systemofrecord            UNNECESSARY
# posse_jobid               UNNECESSARY


# List the permit dataset variables needed
varsPermits <-
  c('parcel_id_num',
    'permittype',
    'commercialorresidential',
    'typeofwork',
    'permitissuedate',
    'status',
    'applicanttype',
    'address',
    'unit_type',
    'unit_num',
    'opa_owner',
    'lng',
    'lat')

# permittype categories:
permitCats <- 
  c(#'ADMINISTRATIVE',        #    2030
    #'BP_ADDITON',            #    1781
    #'BP_ADMINST',            #    6499
    #'BP_ALTER',              #   33475
    #'BP_DEMO',               #    6259
    #'BP_FIRESUP',            #    9553
    #'BP_MECH',               #   18747
    'BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    #'BP_SIGN',               #    1546
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    #'DEMOLITION',            #    1704
    #'ELECTRICAL',            #   22321
    #'EP_ELECTRL',            #   36433
    #'FIRE SUPPRESSION',      #    7089
    #'GENERAL',               #    1472 
    #'GENERAL PERMIT MINOR',  #    9225
    #'MASTER PLAN',           #      29
    #'MECHANICAL',            #   12662
    #'OPERATIONS',            #     579
    #'OPS PERMIT',            #    2232
    #'PLUMBING',              #   31451
    #'PP_PLUMBNG',            #   52541
    #'PRELIMINARY APPROVAL',  #      27
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    #'SITE / UTILITY PERMIT', #     415
    'ZONING',                 #   11187   # "2015-12-02" to NOW ("2022-01-29")
    #'ZP_ADMIN',              #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING'               #    7617   # "2007-01-02" to "2020-03-12"
    )

permitCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING')              #    7617   # "2007-01-02" to "2020-03-12"

permitCats <- 
  c(#'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    #'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")



# type of work across categories:
permitTypes <- as.data.frame(table(permits$typeofwork))


# Filter data with PERMIT TYPES (building or zoning)
permitsData <- permits %>%
  select(varsPermits) %>%
  filter(permitissuedate > as.Date.character('2017-01-01')) %>% # SET start date
  filter(permittype %in% permitCats) %>%
  # filter(., grepl("NEW CONSTRUCTION", typeofwork)) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = 4269) 


table(permitsData$typeofwork)


# Filter data with TYPE OF WORK (new construction)
permitsData <- permits %>%
  select(varsPermits) %>%
  #filter(permittype %in% permitCats) %>%
  filter(., grepl("NEW CONSTRUCTION", typeofwork)) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = 4269)
  
table(permitsData$permittype)


# quick map plot
m(permitsData, zcol='permittype')

```



#### D2: Real Estate Transfers

Real Estate Transfers Tax Documents

Dataset description:

"Description	This is a summary of real estate transfer tax (RTT) documents. This table contains both raw source data as well as calculated/geocoded data, which are described below. Each row represents a distinct property involved in a RTT transaction document; all properties involved in a transaction share the same document_id. Please note that 918 transactions have been temporarily omitted while we address data integration issues with these records."


```{r demand property assessment}

# OpenDataPhilly Endpoint of Property Assessment History:
transfers <- read_csv('https://opendata-downloads.s3.amazonaws.com/rtt_summary.csv')

# OpenDataPhilly - Transfers (48 variables)
transfersVars <- 
  c(#"objectid",                     # UNNECESSARY
    #"document_id",                  # UNNECESSARY -------------------------------id of the real estate transfer document 
    "document_type",                # KEEP*** -----------------------------------refers to type of Real Estate Transaction
    "display_date",                 # KEEP***
    #"street_address",               # UNNECESSARY
    #"zip_code",                     # UNNECESSARY
    #"ward",                         # UNNECESSARY
    "grantors",                     # KEEP? -------------------------------------seller (on deeds), or borrower (on mortgages)
    "grantees",                     # KEEP? -------------------------------------buyer, recipient, new owner, or lien holder
    #"cash_consideration",           # UNNECESSARY
    #"other_consideration",          # UNNECESSARY
    "total_consideration",          # KEEP?** -----------------------------------good exchanged for the real estate (usually money)
    "assessed_value",               # KEEP?** -----------------------------------assess value by OPA
    #"common_level_ratio",           # UNNECESSARY -------------------------------fair market : assessment values ratio
    "fair_market_value",            # KEEP?** -----------------------------------assessment value by common level ratio
    #"state_tax_amount",             # UNNECESSARY
    #"state_tax_percent",            # UNNECESSARY
    #"local_tax_amount",             # UNNECESSARY
    #"local_tax_percent",            # UNNECESSARY
    #"adjusted_cash_consideration",  # UNNECESSARY
    #"adjusted_other_consideration", # UNNECESSARY
    #"adjusted_total_consideration", # UNNECESSARY
    #"adjusted_assessed_value",      # UNNECESSARY
    #"adjusted_fair_market_value",   # UNNECESSARY
    #"adjusted_state_tax_amount",    # UNNECESSARY
    #"adjusted_local_tax_amount",    # UNNECESSARY
    #"receipt_num",                  # UNNECESSARY
    #"receipt_date",                 # UNNECESSARY - display_date is used
    #"recording_date",               # UNNECESSARY - display_date is used
    #"document_date",                # UNNECESSARY - display_date is used
    #"condo_name",                   # UNNECESSARY
    #"unit_num",                     # UNNECESSARY
    #"address_low",                  # UNNECESSARY
    #"address_low_suffix",           # UNNECESSARY
    #"address_low_frac",             # UNNECESSARY
    #"address_high",                 # UNNECESSARY
    #"street_predir",                # UNNECESSARY
    #"street_name",                  # UNNECESSARY
    #"street_suffix",                # UNNECESSARY
    #"street_postdir",               # UNNECESSARY
    "reg_map_id",                   # KEEP*** to join ---------------------------DOR parcel ID sourced from CRIS_Properties.
    "matched_regmap",               # KEEP? -------------------------------------DOR parcel ID matched to the address by the geocoder.
    "opa_account_num",              # KEEP****to join
    #"legal_remarks",                # UNNECESSARY
    #"discrepancy",                  # UNNECESSARY
    "property_count",               # KEEP --------------------------------------Number of properties in document
    "lat",                          # KEEP
    "lng")                          # KEEP



# Data wrangle
transfersData <- transfers %>%
  dplyr::select(transfersVars) %>%
  filter(display_date > as.Date.character('2017-01-01'))


```





### ACS Data

```{r ACS data}




```



### Other Data

```{r demand data violations}

# Load VIOLATIONS data from OpenDataPhilly's Carto API
violations <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*,+ST_Y(the_geom)+AS+lat,+ST_X(the_geom)+AS+lng+FROM+violations&filename=violations&format=csv&skipfields=cartodb_id')


```









