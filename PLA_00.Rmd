---
title: "Philadelphia Legal Assistance: Adverse Possession"
author: "Adrian Leon, Max Masuda-Farkas, Gillian Xuezhu Zhao"
date: "28/01/2022"
output:
    html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---


# Philadelphia Legal Assistance

## Smart Cities Practicum

```{r setup, include=FALSE}

# R Markdown options
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F, results = F, cache=T)

# LOAD PACKAGES
library(sf)
library(riem)
library(caret)
library(spdep)
library(knitr)
library(gifski)
library(tigris)
library(mapview)
library(geojsonR)
library(tidyverse)
library(tidycensus)
library(lubridate)
library(gganimate)
library(gridExtra)
library(kableExtra)

# R options setup
options(scipen = 999)
options(tigris_class = "sf")

# additional functions from PPA book
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


# function shortcuts
g <- glimpse
m <- mapview
len <- length
st_c <- st_coordinates


```


### Geographic boundaries

```{r geometry}

phlcrs <- 'EPSG:32129' #'EPSG:3364' #'EPSG:4269'

# # get geometry for blocks in Philadelphia
# phlblocks <- tigris::blocks(state = 42, county = 101) %>%
#   dplyr::select(GEOID10, geometry)
# 
# # get geometry for block groups in Philadelphia
# phlgroups <- tigris::block_groups(state = 42, county = 101) %>%
#   dplyr::select(GEOID, geometry)

# get geometry for tracts in Philadelphia
phltracts <- tigris::tracts(state = 42, county = 101) %>%
  dplyr::select(GEOID, geometry) %>%
  st_transform(st_crs(phlcrs))

# get geometry for the county of Philadelphia
phlcounty <- tigris::counties(state = 42) %>%
  filter(GEOID == '42101') %>%
  dplyr::select(GEOID, geometry) %>%
  st_transform(st_crs(phlcrs))


```



### Supply-side data

#### S1: US Bank Liens

```{r supply-side data}

# Client-provided US Bank Liens Data (as 'US Bank sharp') - 2019 2020
# These are Liens that have been sold - UPDATE?
usBankLiens_0 <- read.csv("./data/usBank.csv") %>%
  dplyr::select(-X) %>%
  na.omit() %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326, agr = 'constant')


# US Bank Liens geocoded (by GILLIAN):
usBankLiens_1 <- read.csv("./data/usBankLiens_latlon.csv") %>%
  rename(lon = 'long') %>%
  filter(!is.na(lat), !is.na(lon)) %>% 
  st_as_sf(coords = c("lon","lat"), crs = 4269)  %>%
  filter(X != 16)                                                # TAKE out Mississippi geocode error


# US Bank Liens pending geocoding (with NAs):
usBankLiens_NA <- read.csv("./data/usBankLiens_latlonNA.csv") %>%
  rename(lon = 'long')


# visualize liens locations
m(usBankLiens_1, zcol='CALC_TOTAL')
```





#### S2: Real Estate Tax Delinquencies

```{r supply tax delinquencies}

# Real Estate Delinquencies from OpenData Philly:
delinquencies <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+real_estate_tax_delinquencies&filename=real_estate_tax_delinquencies&format=csv&skipfields=cartodb_id,the_geom,the_geom_webmercator')

# Variables - Tax Delinquencies (53 vars)
delinquenciesVars <-
  c(#"objectid",                       # UNNECESSARY
    "opa_number",                     # KEEP to JOIN****
    "street_address",                 # KEEP to JOIN check****
    #"zip_code",                       # UNNECESSARY
    #"zip_4",                          # UNNECESSARY
    #"unit_type",                      # UNNECESSARY
    #"unit_num",                       # UNNECESSARY
    #"owner",                          # UNNECESSARY
    #"co_owner",                       # UNNECESSARY
    #"principal_due",                  # UNNECESSARY -----------------------------The amount of principal due.
    #"penalty_due",                    # UNNECESSARY -----------------------------The penalty amount due.
    #"interest_due",                   # UNNECESSARY -----------------------------The amount of interest due.
    #"other_charges_due",              # UNNECESSARY -----------------------------Additional charges owner owes.
    "total_due",                      # KEEP ------------------------------------The total amount owner owes.
    "is_actionable",                  # KEEP?*** --------------------------------Action can be taken against the delinquent property.
    #"payment_agreement",              # UNNECESSARY -----------------------------The property owner is in a payment agreement.
    "num_years_owed",                 # KEEP ***for adverse possession reference
    "most_recent_year_owed",          # KEEP for reference
    "oldest_year_owed",               # KEEP for reference
    "most_recent_payment_date",       # KEEP for reference
    "year_of_last_assessment",        # KEEP for reference
    "total_assessment",               # KEEP for reference
    #"taxable_assessment",             # UNNECESSARY
    #"mailing_address",                # UNNECESSARY
    #"mailing_city",                   # UNNECESSARY
    #"mailing_state",                  # UNNECESSARY
    #"mailing_zip",                    # UNNECESSARY
    #"return_mail",                    # UNNECESSARY
    #"building_code",                  # ???? ------------------------------------Building codes describe the building.
    #"detail_building_description",    # ???? ------------------------------------Description of the building code.
    #"general_building_description",   # ???? ------------------------------------General description of how the building is used.
    "building_category",              # ???? ------------------------------------Type of Building Group (residential, commercial, etc.).
    #"coll_agency_num_years",          # ???? ------------------------------------TO COLLECTION AGENCY
    #"coll_agency_most_recent_year",   # ???? ------------------------------------TO COLLECTION AGENCY
    #"coll_agency_oldest_year",        # ???? ------------------------------------TO COLLECTION AGENCY
    #"coll_agency_principal_owed",     # ???? ------------------------------------TO COLLECTION AGENCY
    #"coll_agency_total_owed",         # ???? ------------------------------------TO COLLECTION AGENCY
    #"exempt_abatement_assessment",    # UNNECESSARY -----------------------------The amount excluded from the tax base.
    #"homestead_value",                # UNNECESSARY -----------------------------Amount of Homestead Exemption.
    #"net_tax_value_after_homestead",  # ???? ------------------------------------The net tax value after the homestead exemption.
    #"agreement_agency",               # UNNECESSARY -----------------------------Either "TIPS","lbr","grb","LAW" 
    #"sequestration_enforcement",      # UNNECESSARY -----------------------------If the property is a rental, the city can collect rent
    #"bankruptcy",                     # UNNECESSARY -----------------------------Active bankruptcy
    #"years_in_bankruptcy",            # UNNECESSARY 
    #"most_recent_bankrupt_year",      # UNNECESSARY
    #"oldest_bankrupt_year",           # UNNECESSARY
    #"principal_sum_bankrupt_years",   # UNNECESSARY
    #"total_amount_bankrupt_years",    # UNNECESSARY
    "sheriff_sale",                   # KEEP*** ---------------------------------Property is in the Sheriff Sale Process (any stage).
    "liens_sold_1990s",               # KEEP*** ---------------------------------Property was included in 1997 Lien Sale.
    "liens_sold_2015")                # KEEP*** ---------------------------------Property is included in Recent Lien Sales.
    #"assessment_under_appeal",        # UNNECESSARY -----------------------------the owner has appealed the assessment.
    #"year_month")                     # year$month >>>> Unlisted in metadata


# Data wrangling
delinquenciesData <- delinquencies %>%
  dplyr::select(delinquenciesVars) %>%
  rename("address" = street_address) %>%
  mutate(opa_number = sprintf("%09d", opa_number))
  #filter(sheriff_sale == 'Y')

# table(delinquenciesData$sheriff_sale)
```





### P1: Properties dataset

```{r supply all properties description}

# Load properties from 99 until now from ODP.
properties <- read_csv('https://opendata-downloads.s3.amazonaws.com/opa_properties_public.csv')


# Selected variables of interest
propertiesVars <-
  c(#"objectid",                       # UNNECESSARY
    #"assessment_date",                # UNNECESSARY
    #"basements",                      # UNNECESSARY
    #"beginning_point",                # UNNECESSARY
    #"book_and_page",                  # UNNECESSARY
    #"building_code",                  # UNNECESSARY
    #"building_code_description",      # UNNECESSARY
    "category_code",                  # KEEP ------------------------------------determines if it is VACANT LAND
    #"category_code_description",      # KEEP ------------------------------------determines if it is VACANT LAND
    #"census_tract",                   # UNNECESSARY
    #"central_air",                    # UNNECESSARY
    #"cross_reference",                # UNNECESSARY
    #"date_exterior_condition",        # UNNECESSARY
    #"depth",                          # UNNECESSARY
    #"exempt_building",                # UNNECESSARY
    #"exempt_land",                    # UNNECESSARY
    "exterior_condition",             # KEEP ------------------------------------how the exterior appears based on observation.
    #"fireplaces",                     # UNNECESSARY
    #"frontage",                       # UNNECESSARY
    #"fuel",                           # UNNECESSARY
    #"garage_spaces",                  # UNNECESSARY
    #"garage_type",                    # UNNECESSARY
    #"general_construction",           # UNNECESSARY
    #"geographic_ward",                # UNNECESSARY
    #"homestead_exemption",            # UNNECESSARY
    #"house_extension",                # UNNECESSARY
    #"house_number",                   # UNNECESSARY
    #"interior_condition",             # UNNECESSARY
    "location",                       # KEEP for JOIN check****
    #"mailing_address_1",              # UNNECESSARY
    #"mailing_address_2",              # UNNECESSARY
    #"mailing_care_of",                # UNNECESSARY
    #"mailing_city_state",             # UNNECESSARY
    #"mailing_street",                 # UNNECESSARY
    #"mailing_zip",                    # UNNECESSARY
    "market_value",                   # KEEP ------------------------------------the certified market value of the property.
    #"market_value_date",              # UNNECESSARY
    #"number_of_bathrooms",            # UNNECESSARY
    #"number_of_bedrooms",             # UNNECESSARY
    #"number_of_rooms",                # UNNECESSARY
    #"number_stories",                 # UNNECESSARY
    #"off_street_open",                # UNNECESSARY
    #"other_building",                 # UNNECESSARY
    "owner_1",                        # KEEP?
    "owner_2",                        # KEEP?
    "parcel_number",                  # KEEP to JOIN***
    #"parcel_shape",                   # UNNECESSARY
    #"quality_grade",                  # UNNECESSARY
    #"recording_date",                 # KEEP? -----------------------------------date the deed was presented to records.
    "registry_number",                # KEEP to JOIN
    "sale_date",                      # KEEP
    "sale_price",                     # KEEP
    #"separate_utilities",             # UNNECESSARY
    #"sewer",                          # UNNECESSARY
    #"site_type",                      # UNNECESSARY
    #"state_code",                     # UNNECESSARY
    #"street_code",                    # UNNECESSARY
    #"street_designation",             # UNNECESSARY
    #"street_direction",               # UNNECESSARY
    #"street_name",                    # UNNECESSARY
    #"suffix",                         # UNNECESSARY
    #"taxable_building",               # UNNECESSARY
    #"taxable_land",                   # UNNECESSARY
    #"topography",                     # UNNECESSARY
    "total_area",                     # KEEP
    #"total_livable_area",             # UNNECESSARY
    #"type_heater",                    # UNNECESSARY
    #"unfinished",                     # UNNECESSARY
    #"unit",                           # UNNECESSARY
    #"utility",                        # UNNECESSARY
    #"view_type",                      # UNNECESSARY
    "year_built",                     # KEEP?
    #"year_built_estimate",            # UNNECESSARY
    #"zip_code",                       # UNNECESSARY
    "zoning",                         # KEEP
    "pin",                            # KEEP to JOIN ****
    "lat",                            # KEEP****
    "lng")                            # KEEP****

# Data wrangling
propertiesData <- properties %>%
  dplyr::select(propertiesVars) %>%
  rename("address" = location) %>%
  filter(!is.na(lat), !is.na(lng)) %>%              ### REMOVE before joining to parcels!!!
  st_as_sf(coords = c("lat","lng"), crs = 4326) %>%
  st_transform(st_crs(phlcrs))



```



#### P2: Parcels dataset

```{r supply all parcels}

# Philadelphia Department of Registration Parcel data (41 variable
parcels <- st_read('https://opendata.arcgis.com/datasets/1c57dd1b3ff84449a4b0e3fb29d3cafd_0.geojson')

# Select useful variables
parcelsVars <- 
  c(#"OBJECTID",                         # UNNECESSARY
    #"RECSUB",                           # UNNECESSARY
    "BASEREG",                          # KEEP to JOIN -----------------------------The registry number which there is a deed attached to.
    "MAPREG",                           # UNNECESSARY
    #"PARCEL",                           # UNNECESSARY
    #"RECMAP",                           # UNNECESSARY
    #"STCOD",                            # UNNECESSARY
    #"HOUSE",                            # UNNECESSARY
    #"SUF",                              # UNNECESSARY
    #"UNIT",                             # UNNECESSARY
    #"STEX",                             # UNNECESSARY
    #"STDIR",                            # UNNECESSARY
    #"STNAM",                            # UNNECESSARY
    #"STDESSUF",                         # UNNECESSARY
    #"ELEV_FLAG",                        # UNNECESSARY
    #"TOPELEV",                          # UNNECESSARY
    #"BOTELEV",                          # UNNECESSARY
    #"CONDOFLAG",                        # UNNECESSARY
    #"MATCHFLAG",                        # UNNECESSARY
    #"INACTDATE",                        # UNNECESSARY
    "ORIG_DATE",                        # ???? ----------------------------------Date of origination
    "STATUS",                           # ????
    "GEOID",                            # FOR REFERENCE
    #"STDES",                            # UNNECESSARY
    #"ADDR_SOURCE",                      # UNNECESSARY
    "ADDR_STD",                         # KEEP for JOIN check****
    #"COMMENTS",                         # UNNECESSARY
    "PIN",                              # KEEP ----------------------------------Unique parcel identifier
    #"FRAC",                             # UNNECESSARY
    #"UNIT_TYPE",                        # UNNECESSARY
    #"STEX_FRAC",                        # UNNECESSARY
    #"STEX_SUF",                         # UNNECESSARY
    #"SEPARATED_RIGHTS",                 # UNNECESSARY ---------------------------Air Rights, Sub Rights, Mixed Rights, Parking, Garage
    #"MUNIMENT_TYPE",                    # UNNECESSARY
    #"MUNIMENT_ID",                      # UNNECESSARY
    #"DOR_REVIEW",                       # UNNECESSARY
    #"OPA_REVIEW",                       # UNNECESSARY
    #"PWD_REVIEW",                       # UNNECESSARY
    "Shape__Area",                      # KEEP
    #"Shape__Length",                    # KEEP
    "geometry")                         # KEEP


# Data wrangling
parcelsData <- parcels %>%
  dplyr::select(parcelsVars) %>%
  rename("address" = ADDR_STD) %>%
  st_transform(st_crs(phlcrs))


```




#### P3: Vacant lots


From metadata:  "Input characteristics of the model are determined to be either positive or negative indicators of vacancy. A positive indicator has a tendency to signify vacancy (e.g., code violation issued by L+I). A negative indicator has a tendency to signify occupancy (e.g., OPA occupied property code). Individual indicators are weighted based on age of observation/record or other factors as determined by city department subject matter experts for a contributing dataset. Each indicator is also determined to represent a vacant lot or vacant building, as documented in the contributing dataset."


```{r supply vacant land}

# OpenDataPhilly Vacant Property Indicator - Lots
vacantLand <- read_csv('https://opendata.arcgis.com/datasets/19c35fb02d544a9bad0032b58268c9f9_0.csv')

# Select useful variables --- NO GEOMETRY
vacantLandVars <-
  c(#"OBJECTID",                       # UNNECESSARY
    "ADDRESS",                        # KEEP for JOIN CHECK
    #"OWNER1",                         # REPEATED (in Properties)
    #"OWNER2",                         # REPEATED (in Properties)
    "BLDG_DESC",                      # ???? ------------------------------------Building description from OPA
    "OPA_ID",                         # KEEP to JOIN****
    #"LNIADDRESSKEY",                  # UNNECESSARY-----------------------------Unique identifier from Licenses + Inspections
    #"COUNCILDISTRICT",                # UNNECESSARY
    "ZONINGBASEDISTRICT",             # KEEP***
    #"ZIPCODE",                        # UNNECESSARY
    "LAND_RANK")                      # KEEP?
    #"Shape__Area"                    # KEEP?
    #"Shape__Length")                  # UNNECESSARY

# Data wrangling
vacantLandData <- vacantLand %>%
  dplyr::select(vacantLandVars) %>%
  rename("address" = ADDRESS) %>%
  mutate(vacant = 'vacant')

```




### Demand-side data

#### D1: L&I Building and Zoning Permits

```{r demand data permits}

### DEMAND SIDE DATA

initialDate <- as.Date.character('2017-01-01')

# Load PERMITS data from OpenDataPhilly's Carto API
# permits <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*,+ST_Y(the_geom)+AS+lat,+ST_X(the_geom)+AS+lng+FROM+permits&filename=permits&format=csv&skipfields=cartodb_id')

# List the permit data set variables needed
varsPermits <-
  c(#'objectid',                      # UNNECESSARY
    #'permitnumber',                  # UNNECESSARY
    #'addressobjectid',               # UNNECESSARY
    'parcel_id_num',                 # KEEP for JOIN
    'permittype',                    # KEEP*****
    'permitdescription',             # KEEP for reference
    'commercialorresidential',        # MAYBE
    'typeofwork',                    # KEEP****
    #'approvedscopeofwork',           # UNNECESSARY - detailed description
    'permitissuedate',               # KEEP***
    'status',                        # KEEP
    'applicanttype',                 # MAYBE
    #'contractor[...]',               # UNNECESSARY
    #'mostrecentinsp',                # UNNECESSARY
    'opa_account_num',               # KEEP for JOIN****
    'address',                       # KEEP for JOIN check
    #'unit_type',                     # UNNECESSARY
    #'unit_num',                      # UNNECESSARY
    #'zip',                           # UNNECESSARY
    #'censustract',                   # UNNECESSARY
    #'council_district',              # UNNECESSARY
    #'opa_owner',                     # REPETITIVE ------------------------------OPA's ownership from the current deed for the property.
    #'systemofrecord',                # UNNECESSARY
    #'posse_jobid',                   # UNNECESSARY
    'lng','lat'
    #'geometry'
    )

# EXAMINE VARIABLES
# permittype
permitTypes <- as.data.frame(table(permits$permittype))

# select permittyoe
# All categories
permitCats <- 
  c(#'ADMINISTRATIVE',        #    2030
    #'BP_ADDITON',            #    1781
    #'BP_ADMINST',            #    6499
    #'BP_ALTER',              #   33475
    #'BP_DEMO',               #    6259
    #'BP_FIRESUP',            #    9553
    #'BP_MECH',               #   18747
    'BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    #'BP_SIGN',               #    1546
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    #'DEMOLITION',            #    1704
    #'ELECTRICAL',            #   22321
    #'EP_ELECTRL',            #   36433
    #'FIRE SUPPRESSION',      #    7089
    #'GENERAL',               #    1472 
    #'GENERAL PERMIT MINOR',  #    9225
    #'MASTER PLAN',           #      29
    #'MECHANICAL',            #   12662
    #'OPERATIONS',            #     579
    #'OPS PERMIT',            #    2232
    #'PLUMBING',              #   31451
    #'PP_PLUMBNG',            #   52541
    #'PRELIMINARY APPROVAL',  #      27
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    #'SITE / UTILITY PERMIT', #     415
    'ZONING',                 #   11187   # "2015-12-02" to NOW ("2022-01-29")
    'ZP_ADMIN',              #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING'               #    7617   # "2007-01-02" to "2020-03-12"
    )

# Old categories
permitCatsA <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING')              #    7617   # "2007-01-02" to "2020-03-12"

# New categories
permitCatsB <- 
  c('BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING',   #   15909   # "2015-01-06" to NOW ("2022-01-29")
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Building categories
permitBuildingCats <- 
  c('BP_NEWCNST',             #    4984   # "2007-01-02" to "2020-02-20"
    'BUILDING',               #    8521   # "2015-01-12" to NOW ("2022-01-29")
    'RESIDENTIAL BUILDING')   #   15909   # "2015-01-06" to NOW ("2022-01-29")

# Zoning categories
permitZoningCats <- 
  c('ZP_ADMIN',               #     803
    'ZP_USE',                 #    9651   # "2007-01-02" to "2020-03-12"
    'ZP_ZON/USE',             #   12921   # "2007-01-02" to "2020-03-12"
    'ZP_ZONING',              #    7617   # "2007-01-02" to "2020-03-12"
    'ZONING')                 #   11187   # "2015-12-02" to NOW ("2022-01-29")


# Data wrangling ONE
# Filter data with PERMIT TYPES (building or zoning)
permitsData <- permits %>%
  dplyr::select(varsPermits) %>%
  filter(permitissuedate > initialDate) %>% # SET start date
  filter(permittype %in% permitCats) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = phlcrs) 


# type of work across SELECTED categories (48):
permitTypesOfWork <- as.data.frame(table(permitsData$typeofwork)) 

# All categories
permitTypeOfWorkCats <- 
  c(#'ADD',                                              #   1665 ***OLD ***ZONING {New construction attached or added to existing}
    #'ADDITION AND/OR ALTERATION',                       #  17051 ***NEW ***BUILDING (6290)  ***RESIDENTIAL BUILDING (10761)
    #'ALTER',                                            #      1 ***OLD ***ZONING
    #'AMEND',                                            #    162 ***OLD ***ZONING {Admin stuff}
    #'CHANGE OF USE',                                    #   3046 ***NEW ***ZONING {General change of use}
    'COMBINED LOT LINE RELOCATION AND NEW DEVELOPMENT', #    313 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'COMDEM',                                           #   1163 ***OLD ***ZONING {Complete demolition}
    #'CONDITIONAL ZONING APPROVAL',                      #     30 ***NEW ***ZONING
    #'CONR',                                             #      1 ***OLD ***ZONING
    #'COVID-19 TEMP USE (RESTAURANTS / RETAIL)',         #     71 ***NEW ***ZONING
    #'ENTIR',                                            #      3 ***OLD ***ZONING (-1)    ***BUILDING
    'ENTIRE',                                           #   2910 ***OLD ***ZONING (-2890) ***BUILDING {Entire structure}
    'ENTSTR',                                           #   3638 ***OLD ***ZONING
    #'FAMDAY',                                           #    268 ***OLD ***ZONING
    #'FAMILY DAYCARE',                                   #     65 ***NEW ***ZONING
    #'FENCE',                                            #     40 ***OLD ***ZONING
    #'FENCES ONLY',                                      #     26 ***NEW ***ZONING
    #'FITOUT',                                           #     91 ***OLD ***BUILDING {Commercial interiors}
    #'FOUND',                                            #    168 ***OLD ***BUILDING {Just foundations}
    #'FRAME',                                            #      1 ***OLD ***BUILDING
    'FULL DEMOLITION',                                  #    644 ***NEW ***ZONING {Full demolition}
    'LOT LINE RELOCATION',                              #    317 ***NEW ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    'LOTLIN',                                           #   2527 ***OLD ***ZONING {Combine or redraw lots} ***SIGNIFICATIVE!
    #'MAJOR',                                            #      4 ***OLD ***ZONING (-3) ***BUILDING
    #'MOD/IN',                                           #     17 ***OLD ***BUILDING {Modular structure}
    'NEW CONSTRUCTION',                                 #<- 6292 ***NEW ***BUILDING (1812) ***RESIDENTIAL BUILDING (4480)
    'NEW CONSTRUCTION (SHELL ONLY)',                    #<-   19 ***NEW ***BUILDING
    #'NEW CONSTRUCTION (STAND ALONE)',                   #<-   48 ***NEW ***RESIDENTIAL BUILDING
    'NEW CONSTRUCTION, ADDITION, GFA CHANGE',           #<- 4986 ***NEW ***ZONING {New construction attached or added to existing}
    'NEWCON'#                                           #<- 5539 ***OLD ***ZONING (-3) ***BUILDING {New construction of structure}
    #'PARKING ONLY',                                     #<-   97 ***NEW ***ZONING
    #'PARTBL',                                           #    116 ***OLD ***ZONING {Partial demolitions}
    #'PARTCH',                                           #   3317 ***OLD ***ZONING {Change in use}
    #'PARTIA',                                           #      4 ***OLD ***ZONING {Partial or complete demolitions}
    #'PARTSI',                                           #     36 ***OLD ***ZONING {Partial or complete demolitions}
    #'PRELIM',                                           #      6 ***OLD ***ZONING {Preliminary study}
    #'PREPL',                                            #      1
    #'SFADD',                                            #   3149 ***OLD ***ZONING {Add square footage to existing}
    #'SFRED',                                            #    253 ***OLD ***ZONING {Reduce square footage to existing}
    #'SHELL',                                            #      9 ***OLD ***BUILDING
    #'SIGNAC',                                           #   1584 ***OLD ***ZONING
    #'SIGNE',                                            #     19 ***OLD ***ZONING
    #'SIGNNA',                                           #     18 ***OLD ***ZONING
    #'SIGNS (ACCESSORY / NON-ACCESSORY)',                #    872 ***NEW ***ZONING
    #'SITE',                                             #     29 ***OLD ***BUILDING
    #'TANK',                                             #     27 ***OLD ***ZONING (-26) ***BUILDING
    #'TANKRI',                                           #      1 ***OLD ***BUILDING
    #'ZBAADM'                                            #    332 ***OLD ***ZONING {Admin stuff}
    )
    

# Data wrangling TWO
# Filter data with PERMIT TYPES (building or zoning)

# Get ZONING permits
permitsZoningData <- permitsData %>%
  filter(permittype %in% permitZoningCats) %>%
  filter(typeofwork %in% permitTypeOfWorkCats)

as.data.frame(table(permitsZoningData$typeofwork)) 


# Get ZONING permits
permitsBuildingData <- permitsData %>%
  filter(permittype %in% permitBuildingCats) %>%
  filter(typeofwork %in% permitTypeOfWorkCats)

as.data.frame(table(permitsBuildingData$typeofwork)) 

# quick map plot
# m(permitsData, zcol='permittype')

# Data wrangling THREE
# Filter data with zoning permits and typeofwork relevant to our use case
# across all years
zoningPermitsProps_allYrs <- permits %>%
  dplyr::select(varsPermits) %>%
  # filter(permitissuedate > initialDate) %>% # SET start date
  filter(permittype %in% permitZoningCats,
         typeofwork %in% permitTypeOfWorkCats) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = phlcrs)

# save locally
# Gillian's: saveRDS(zoningPermitsProps_allYrs, file = "C:/Users/m1861/Desktop/CPLN790_MUSAPracticum/Data_Box/local/zoningPermitsProps_allYrs.rds")
```



#### D2: Real Estate Transfers

Real Estate Transfers Tax Documents

Dataset description:

"Description	This is a summary of real estate transfer tax (RTT) documents. This table contains both raw source data as well as calculated/geocoded data, which are described below. Each row represents a distinct property involved in a RTT transaction document; all properties involved in a transaction share the same document_id. Please note that 918 transactions have been temporarily omitted while we address data integration issues with these records."


```{r demand property assessment}

# OpenDataPhilly Endpoint of Property Assessment History:
transfers <- read_csv('https://opendata-downloads.s3.amazonaws.com/rtt_summary.csv')

# OpenDataPhilly - Transfers (48 variables)
transfersVars <- 
  c(#"objectid",                     # UNNECESSARY
    #"document_id",                  # UNNECESSARY -------------------------------id of the real estate transfer document 
    "document_type",                # KEEP*** -----------------------------------refers to type of Real Estate Transaction
    "display_date",                 # KEEP***
    "street_address",               # KEEP for JOIN check
    #"zip_code",                     # UNNECESSARY
    #"ward",                         # UNNECESSARY
    "grantors",                     # KEEP? -------------------------------------seller (on deeds), or borrower (on mortgages)
    "grantees",                     # KEEP? -------------------------------------buyer, recipient, new owner, or lien holder
    #"cash_consideration",           # UNNECESSARY
    #"other_consideration",          # UNNECESSARY
    #"total_consideration",          # KEEP?** -----------------------------------good exchanged for the real estate (usually money)
    #"assessed_value",               # KEEP?** -----------------------------------assess value by OPA
    #"common_level_ratio",           # UNNECESSARY -------------------------------fair market : assessment values ratio
    "fair_market_value",            # KEEP?** -----------------------------------assessment value by common level ratio
    #"state_tax_amount",             # UNNECESSARY
    #"state_tax_percent",            # UNNECESSARY
    #"local_tax_amount",             # UNNECESSARY
    #"local_tax_percent",            # UNNECESSARY
    #"adjusted_cash_consideration",  # UNNECESSARY
    #"adjusted_other_consideration", # UNNECESSARY
    #"adjusted_total_consideration", # UNNECESSARY
    #"adjusted_assessed_value",      # UNNECESSARY
    #"adjusted_fair_market_value",   # UNNECESSARY
    #"adjusted_state_tax_amount",    # UNNECESSARY
    #"adjusted_local_tax_amount",    # UNNECESSARY
    #"receipt_num",                  # UNNECESSARY
    #"receipt_date",                 # UNNECESSARY - display_date is used
    #"recording_date",               # UNNECESSARY - display_date is used
    #"document_date",                # UNNECESSARY - display_date is used
    #"condo_name",                   # UNNECESSARY
    #"unit_num",                     # UNNECESSARY
    #"address_low",                  # UNNECESSARY
    #"address_low_suffix",           # UNNECESSARY
    #"address_low_frac",             # UNNECESSARY
    #"address_high",                 # UNNECESSARY
    #"street_predir",                # UNNECESSARY
    #"street_name",                  # UNNECESSARY
    #"street_suffix",                # UNNECESSARY
    #"street_postdir",               # UNNECESSARY
    #"reg_map_id",                   # UNNECESSARY ------------------------------DOR parcel ID sourced from CRIS_Properties.
    #"matched_regmap",               # UNNECESSARY ------------------------------DOR parcel ID matched to the address by the geocoder.
    "opa_account_num",              # KEEP****to join
    #"legal_remarks",                # UNNECESSARY
    #"discrepancy",                  # UNNECESSARY
    "property_count")               # KEEP --------------------------------------Number of properties in document
    #"lat",                          # KEEP
    #"lng")                          # KEEP


# Data wrangling
transfersData <- transfers %>%
  #filter(display_date > initialDate) %>%
  dplyr::select(transfersVars) %>%
  rename('address' = street_address) %>%
  filter(!is.na(opa_account_num)) %>%
  filter(document_type %in% c('DEED',
                              'DEED LAND BANK',
                              'DEED MISCELLANEOUS',
                              'DEED MISCELLANEOUS TAXABLE',
                              'DEED OF CONDEMNATION',
                              'DEED SHERIFF'))
  
table(transfers$document_type)

```




### ACS Data

```{r ACS data}


censusKey <-  #'c2bdb8d298b60ec0cb50b561a2f8df61e92f6b39' # read_file('../censusapikey.R')

# load census api key from local file
census_api_key(censusKey)

year <- 2021

acsVariableList <- load_variables(2021, "acs5", cache = TRUE)


censusVars <-
  c("B02001_001E", # Total population 
    "B11001_002E", # Total households
    "B02001_002E", # Total white population 
    "B19013_001E") # Median household income

    ## ADD house ownership (to show pct of renters and owners
)


# Get the data
tracts19 <-
  get_acs(geography = "tract",
          variables = censusVars,
          year = year,
          state = 42,
          county = 101,
          geometry= T,
          output = "wide") %>%
  st_transform(st_crs(phlcrs)) %>%
  rename(totalPop = "B02001_001E",
         totalHHs = "B11001_002E",
         whitePop = "B02001_002E",
         medHHInc = "B19013_001E") %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  replace(is.na(.), 0) %>%
  mutate(pctWhite = ifelse(totalPop > 0, whitePop / totalPop, 0)) %>%
  dplyr::select(-whitePop)


```



### Join Datasets
#### Join test

```{r join datasets wiota}

# Join Test in particular Street

# Generate addresses for whole street
streetName <- 'WIOTA ST'

addresses <- list()
for (i in 50:700){
  address <- paste0(as.character(i),' ',streetName)
  addresses <- append(addresses, address)
}


# supply side
x <- propertiesData %>%
  filter(address %in% addresses)
y <- parcelsData %>%
  filter(address %in% addresses)
z <- vacantLandData %>%
  filter(address %in% addresses)


# demand side
a <- permitsData %>%
  filter(address %in% addresses)
b <- delinquenciesData %>%
   filter(address %in% addresses)
c <- transfersData %>%
  filter(address %in% addresses)


```


### Parcels with properties

```{r join properties to parcels}

# propertiesData <---> parcelsData

# check length of JOIN variables A
len(unique(propertiesData$pin))
len(unique(parcelsData$PIN))

# get matching success rate using 'pin' = 'PIN'
table(unique(propertiesData$pin) %in% unique(parcelsData$PIN))
table(unique(parcelsData$PIN) %in% unique(propertiesData$pin))

# check length of JOIN variables B
len(unique(propertiesData$registry_number))
len(unique(parcelsData$MAPREG))

# get matching success rate using 'pin' = 'PIN'
table(unique(propertiesData$registry_number) %in% unique(parcels$MAPREG))
table(unique(parcels$MAPREG) %in% unique(propertiesData$registry_number))
58063/(508189+58063)    # 10% of properties not joined
94027/(94027+508189)    # 16% of parcels not joined

# join propertiesData to parcelData
parcelsProps_A <- propertiesData %>%
  st_drop_geometry() %>%
  inner_join(parcelsData, by=c('pin'='PIN'), keep=T)

# # get properties that were not joined by pin
# notJoined <- propertiesData %>%
#   filter(!pin %in% unique(parcelsProps$pin))
# 
# # join the ones that couldn't be joined by pin=PIN by their registry number?
# parcelsProps_B <- notJoined %>%
#   st_drop_geometry() %>%
#   inner_join(., parcelsData, by=c('registry_number'='BASEREG'), keep=T)

# unite two different join types
#parcelsProps <- cbind(parcelsProps_A, parcelsProps_B)
parcelsProps <- parcelsProps_A

# save locally
# saveRDS(parcelsProps, file = "./local/parcelProps.rds")


```


### Vacant Land to properties


```{r join properties to vacantLand}

# propertiesData <---> vacantLandData

len(unique(vacantLandData$parcel_number))

table(unique(vacantLandData$OPA_ID) %in% unique(propertiesData$parcel_number))
table(unique(propertiesData$parcel_number) %in% unique(vacantLandData$OPA_ID))

49/(27579+49)           # 0.2% of vacantLand rows lost
27579/(27579+553725)    # 4.7% of properties joined to vacantLand

vacantLandProps <- propertiesData %>%
  inner_join(vacantLandData, by=c('parcel_number'='OPA_ID'))

# save locally
# saveRDS(vacantLandProps, file = "./local/vacantLandProps.rds")


```




```{r join permits to properties}

# permitsZoningData <---> propertiesData

len(unique(permitsZoningData$opa_account_num))

table(unique(permitsZoningData$opa_account_num) %in% unique(propertiesData$parcel_number))
table(unique(propertiesData$parcel_number) %in% unique(permitsZoningData$opa_account_num)) 

540/(31466+540)         # 1.7% of permits rows lost
31466/(31466+549838)    # 5.4% of properties joined to permits

permitsProps <- propertiesData %>%
  inner_join(st_drop_geometry(permitsZoningData),  by = c('parcel_number'='opa_account_num'))

# save locally
# saveRDS(permitsProps, file = "./local/permitsProps.rds")



z <- vacantLandProps %>% left_join(., parcelsProps, by='parcel_number')

??inner_join

```




```{r permits map}

# set up the fishnet bins to sort the permits into
fishnet <- phlcounty %>%
  st_make_grid(.,
               cellsize = 250, 
               square = TRUE) %>%
  .[phlcounty] %>%                     # clip to Philadelphia County boundary
  st_sf() %>%
  mutate(uniqueID = rownames(.))


permitStartDate <- as.Date.character('2017-01-01')
permitEndDate <- as.Date.character('2017-04-01')


permitsZoningProps <- 
  permitsProps %>%
  filter(permitissuedate > permitStartDate) %>%
  filter(permitissuedate < permitEndDate)


# add a value of 1 to each and join them to the fishnet
permitsNet <-
  dplyr::select(permitsZoningProps) %>%
  mutate(countPermits = 1) %>%
  aggregate(fishnet, sum) %>%                                                   # used as a spatial join that sums
  mutate(countPermits = replace_na(countPermits, 0)) %>%
  mutate(uniqueID = rownames(.)) %>%
  mutate(cvID = sample(round(nrow(fishnet)/24), size=nrow(fishnet), replace=T)) # random cross validation ID (out of 100) for later use

m(permitsNet, zcol='countPermits')

```










### Delinquencies to properties

```{r join delinquencies to properties}

# propertiesData <---> delinquenciesData

len(unique(delinquenciesData$opa_number))

table(unique(delinquenciesData$opa_number) %in% unique(propertiesData$parcel_number))
table(unique(propertiesData$parcel_number) %in% unique(delinquenciesData$opa_number))

2077/(70639+2077)       #  3%
70639/(70639+510665)    # 12%

initialDate = '2017-01-01'
finalDate = '2021-01-01'

delinquenciesProps <- propertiesData %>%
  inner_join(delinquenciesData, by = c('parcel_number'='opa_number')) %>%
  #filter(category_code == 6) %>%
  #filter(sheriff_sale == 'Y') %>%
  #mutate(debtPercentage = total_due/market_value) %>%
  filter(sale_date >= initialDate & sale_date < finalDate) %>%
  st_sf()

delinquenciesProps_allYrs <- propertiesData %>%
  inner_join(delinquenciesData, by = c('parcel_number'='opa_number')) %>%
  #filter(category_code == 6) %>%
  #filter(sheriff_sale == 'Y') %>%
  #mutate(debtPercentage = total_due/market_value) %>%
  st_sf()

# save locally
# saveRDS(delinquenciesProps, file = "./local/delinquenciesProps.rds")
# Gillian's: saveRDS(delinquenciesProps, file = "C:/Users/m1861/Desktop/CPLN790_MUSAPracticum/Data_Box/local/delinquenciesProps.rds")
# saveRDS(delinquenciesProps_allYrs, file = "C:/Users/m1861/Desktop/CPLN790_MUSAPracticum/Data_Box/local/delinquenciesProps_allYrs.rds")

```


### Transfers to properties


```{r join transfers to properties}
# has data for sheriff sale up until 07/07/2021
# propertiesData <---> transfersData

len(unique(transfersData$opa_account_num))

table(unique(transfersData$opa_account_num) %in% unique(propertiesData$parcel_number))
table(unique(propertiesData$parcel_number) %in% unique(transfersData$opa_account_num))

424/(58427+425)       #  1%
58427/(58427+522877)  # 10%

transfersProps <- propertiesData %>%
  inner_join(transfersData, by= c('parcel_number'='opa_account_num')) #%>%
  
# save locally
# saveRDS(transfersProps, file = "./local/transfersProps.rds")
# Gillian's all years
# saveRDS(transfersProps, file = "C:/Users/m1861/Desktop/CPLN790_MUSAPracticum/Data_Box/local/transfersProps_allYrs.rds")
```

### Look up by census tract


```{r join datasets census tract}

sf::sf_use_s2(F)

myTract <- phltracts %>%
  filter(GEOID ==	'42101009200') %>%
  st_transform(st_crs(phlcrs))

myProperties <- propertiesData %>%
  st_transform(st_crs(phlcrs)) %>%
  st_filter(., myTract)

myParcels <- parcelsData %>%
  st_filter(., myTract)

myLots <- myProperties %>%
  st_drop_geometry() %>%
  inner_join(myParcels, by=c('pin'='PIN')) %>%
  st_sf()


myDelinquencies <- delinquenciesData %>%
  st_transform()

myPermits <- permitsData %>%
  st_transform(st_crs(phlcrs)) %>%
  #filter(permittype == 'BUILDING') %>%
  st_filter(., myTract)


```












