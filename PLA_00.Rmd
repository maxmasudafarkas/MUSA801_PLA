---
title: "PLA_01"
author: "Adrian Leon, Max Masuda-Farkas, Gillian Xuezhu Zhao"
date: "28/01/2022"
output:
    html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---


# Philadelphia Legal Assistance



```{r setup, include=FALSE}

# R Markdown options
knitr::opts_chunk$set(echo = T, warning = F, error = F, message = F, results = F, cache=T)

# LOAD PACKAGES
library(sf)
library(riem)
library(caret)
library(spdep)
library(knitr)
library(gifski)
library(tigris)
library(mapview)
library(geojsonR)
library(tidyverse)
library(lubridate)
library(gganimate)
library(gridExtra)
library(kableExtra)

# R options setup
options(scipen = 999)
options(tigris_class = "sf")

# additional functions from PPA book
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")


# function shortcuts
g <- glimpse
m <- mapview
len <- length
st_c <- st_coordinates


```




### Supply-side data

```{r supply-side data}

# Client-provided US Bank Liens Data (as 'US Bank sharp')
usBankLiens_0 <- read.csv("./data/usBank.csv") %>%
  dplyr::select(-X) %>%
  na.omit() %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326, agr = 'constant')


# US Bank Liens geocoded (by GILLIAN):
usBankLiens_1 <- read.csv("./data/usBankLiens_latlon.csv") %>%
  rename(lon = 'long') %>%
  filter(!is.na(lat), !is.na(lon)) %>% 
  st_as_sf(coords = c("lon","lat"), crs = 4269) %>%
  filter(X != 16)


m(usBankLiens_1, zcol='CALC_TOTAL')


# Properties with NAs
usBankLiens_NA <- read.csv("./data/usBankLiens_latlonNA.csv") %>%
  rename(lon = 'long') # %>%
  #filter(!is.na(lat), !is.na(lon)) %>% 
  # st_as_sf(coords = c("lon","lat"), crs = 4269)
  

```


#### Vacant lots


```{r supply vacant land}

# OpenDataPhilly Vacant Property Indicator - Lots
vacantLand <- read_csv('https://opendata.arcgis.com/datasets/19c35fb02d544a9bad0032b58268c9f9_0.csv')


```



#### Parcels dataset

```{r supply all parcels}

parcels <- read_csv('https://opendata.arcgis.com/datasets/1c57dd1b3ff84449a4b0e3fb29d3cafd_0.csv')

```





### Demand-side data

#### OpenDataPhilly L&I Building and Zoning Permits


```{r demand data permits}

# Load PERMITS data from OpenDataPhilly's Carto API
permits <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*FROM+permits&filename=permits&format=csv&skipfields=cartodb_id')

# objectid                  UNNECESSARY
# permitnumber              UNNECESSARY
# addressobjectid           UNNECESSARY
# parcel_id_num             KEEP for referencing parcels
# permittype                MAYBE
# permitdescription         UNNECESSARY
# commercialorresidential   filter just RESIDENTIAL properties?
# typeofwork                MAYBE
# approvedscopeofwork       UNNECESSARY
# permitissuedate           *KEEP
# status                    KEEP
# applicanttype             MAYBE
# contractor[...]           UNNECESSARY
# mostrecentinsp            UNNECESSARY
# opa_account_num           UNNECESSARY
# address                   KEEP
# unit_type                 MAYBE
# unit_num                  MAYBE keep and match with address?
# zip                       UNNECESSARY
# censustract               UNNECESSARY
# council_district          UNNECESSARY
# opa_owner                 Office of Property Assessment's ownership from the current deed for the property.
# systemofrecord            UNNECESSARY
# posse_jobid               UNNECESSARY


# List the permit dataset variables needed
varsPermits <-
  c('parcel_id_num',
    'permittype',
    'commercialorresidential',
    'typeofwork',
    'permitissuedate',
    'status',
    'applicanttype',
    'address',
    'unit_type',
    'unit_num',
    'opa_owner',
    'lng',
    'lat')

# permittype categories:
permitCats <- 
  c(#'ADMINISTRATIVE',        #    2030
    #'BP_ADDITON',            #    1781
    #'BP_ADMINST',            #    6499
    #'BP_ALTER',              #   33475
    #'BP_DEMO',               #    6259
    #'BP_FIRESUP',            #    9553
    #'BP_MECH',               #   18747
    'BP_NEWCNST',             #    4984
    #'BP_SIGN',               #    1546
    'BUILDING',               #    8521
    #'DEMOLITION',            #    1704
    #'ELECTRICAL',            #   22321
    #'EP_ELECTRL',            #   36433
    #'FIRE SUPPRESSION',      #    7089
    #'GENERAL',               #    1472 
    #'GENERAL PERMIT MINOR',  #    9225
    #'MASTER PLAN',           #      29
    #'MECHANICAL',            #   12662
    #'OPERATIONS',            #     579
    #'OPS PERMIT',            #    2232
    #'PLUMBING',              #   31451
    #'PP_PLUMBNG',            #   52541
    #'PRELIMINARY APPROVAL',  #      27
    'RESIDENTIAL BUILDING',   #   15909
    #'SITE / UTILITY PERMIT', #     415
    'ZONING',                 #   11187
    #'ZP_ADMIN',              #     803
    'ZP_USE',                 #    9651
    'ZP_ZON/USE',             #   12921
    'ZP_ZONING')              #    7617 


# type of work across categories:

permitTypes <- as.data.frame(table(permits$typeofwork))

# Filter data with PERMIT TYPES (building or zoning)
permitsData <- permits %>%
  select(varsPermits) %>%
  filter(permittype %in% permitCats) %>%
  #filter(., grepl("NEW CONSTRUCTION", typeofwork)) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = 4269)

table(permitsData$typeofwork)


# Filter data with TYPE OF WORK (new construction)
permitsData <- permits %>%
  select(varsPermits) %>%
  #filter(permittype %in% permitCats) %>%
  filter(., grepl("NEW CONSTRUCTION", typeofwork)) %>%
  filter(!is.na(lat), !is.na(lng)) %>% 
  st_as_sf(coords = c("lng","lat"), crs = 4269)
  
table(permitsData$permittype)


# quick map plot
m(permitsData, zcol='permittype')

```




```{r demand data violations}

# Load VIOLATIONS data from OpenDataPhilly's Carto API
violations <- read_csv('https://phl.carto.com/api/v2/sql?q=SELECT+*FROM+violations&filename=violations&format=csv&skipfields=cartodb_id')


```









